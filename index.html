<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>OrthoAssist — Practice Management</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&family=Amiri:wght@400;700&display=swap" rel="stylesheet">

<script type="module">
  import { initializeApp }  from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword }
    from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
  import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, updateDoc, onSnapshot, serverTimestamp, query, orderBy, where }
    from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytesResumable, getDownloadURL, listAll, deleteObject }
    from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAUmxmPMbvxHdJ1WPrSxkPJIHNEBQJYAO8",
    authDomain: "orthoassistant-71.firebaseapp.com",
    projectId: "orthoassistant-71",
    storageBucket: "orthoassistant-71.firebasestorage.app",
    messagingSenderId: "1007957638145",
    appId: "1:1007957638145:web:1ddfaf8cace0a8d1ba9400",
    measurementId: "G-9T2T0CGDD5"
  };

  let app, auth, db, storage;
  let FB_READY = false;
  try {
    app     = initializeApp(firebaseConfig);
    auth    = getAuth(app);
    db      = getFirestore(app);
    storage = getStorage(app);
    FB_READY = !!(firebaseConfig.projectId && !firebaseConfig.projectId.includes('YOUR'));
    console.log('[OrthoAssist] Firebase ready:', FB_READY, '| project:', firebaseConfig.projectId);
  } catch(e) {
    console.error('[OrthoAssist] Firebase init error:', e.message);
  }

  window._firebaseConfig = firebaseConfig;
  window._FB = {
    auth, db, storage, FB_READY,
    signIn: signInWithEmailAndPassword,
    signOut, onAuthStateChanged, createUserWithEmailAndPassword,
    collection, doc, setDoc, getDoc, getDocs, deleteDoc, updateDoc,
    onSnapshot, serverTimestamp, query, orderBy, where,
    ref, uploadBytesResumable, getDownloadURL, listAll, deleteObject
  };
  window.dispatchEvent(new Event('fb-ready'));
</script>

<style>
:root{
  --navy:#0a2540;--blue:#1a5fa8;--sky:#3b9eff;
  --ice:#e8f4fd;--ice2:#f4f9ff;--white:#fff;
  --muted:#8da4be;--muted2:#b8cfe4;--text:#1a2e42;--border:#ddeaf6;
  --error:#d64045;--success:#2e9e6b;--warning:#e8930a;--purple:#7c4dff;
  --sw:240px;--th:60px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:'DM Sans',sans-serif;background:var(--navy);color:var(--text)}

/* ═══════ LOGIN ═══════ */
#loginPage{min-height:100vh;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
#loginPage::before{content:'';position:fixed;top:-30%;right:-15%;width:70vw;height:70vw;border-radius:50%;background:radial-gradient(circle,rgba(59,158,255,.12),transparent 70%);pointer-events:none}
.grid-bg{position:fixed;inset:0;background-image:linear-gradient(rgba(59,158,255,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(59,158,255,.04) 1px,transparent 1px);background-size:60px 60px;pointer-events:none}
.lc{display:flex;width:min(900px,95vw);position:relative;z-index:1;animation:fadeUp .7s ease both}
.ll{flex:1;background:linear-gradient(145deg,var(--blue),#0d3d7a);border-radius:20px 0 0 20px;padding:44px 36px;display:flex;flex-direction:column;justify-content:space-between;position:relative;overflow:hidden}
.ll::before{content:'';position:absolute;top:-40px;right:-40px;width:200px;height:200px;border-radius:50%;border:1px solid rgba(255,255,255,.08)}
.bicon{width:46px;height:46px;background:rgba(255,255,255,.12);border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:16px;border:1px solid rgba(255,255,255,.15)}
.bicon svg{width:24px;height:24px}
.bname{font-family:'Cormorant Garamond',serif;font-size:1.9rem;font-weight:600;color:#fff;letter-spacing:-.02em;line-height:1}
.bsub{font-size:.68rem;color:rgba(255,255,255,.45);letter-spacing:.12em;text-transform:uppercase;margin-top:5px}
.pt{font-family:'Cormorant Garamond',serif;font-size:1.5rem;font-weight:300;color:#fff;line-height:1.3;margin-bottom:10px}
.pd{font-size:.8rem;color:rgba(255,255,255,.5);line-height:1.7}
.fl{list-style:none}
.fl li{display:flex;align-items:center;gap:9px;font-size:.76rem;color:rgba(255,255,255,.6);padding:5px 0;border-top:1px solid rgba(255,255,255,.06)}
.fl li:last-child{border-bottom:1px solid rgba(255,255,255,.06)}
.dot{width:6px;height:6px;border-radius:50%;background:var(--sky);flex-shrink:0}
.lr{flex:1.1;background:#fff;border-radius:0 20px 20px 0;padding:44px 40px;display:flex;flex-direction:column;justify-content:center}
.fey{font-size:.68rem;letter-spacing:.15em;text-transform:uppercase;color:var(--sky);font-weight:500;margin-bottom:7px}
.fti{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:600;color:var(--navy);letter-spacing:-.02em}
.fsu{font-size:.8rem;color:var(--muted);margin-top:5px;margin-bottom:24px}

/* role selector */
.role-tabs{display:flex;gap:4px;background:var(--ice2);border-radius:9px;padding:3px;margin-bottom:22px}
.rtab{flex:1;padding:8px 4px;border-radius:7px;font-size:.76rem;font-weight:500;color:var(--muted);cursor:pointer;transition:all .15s;border:none;background:none;text-align:center}
.rtab.active{background:#fff;color:var(--navy);box-shadow:0 1px 4px rgba(0,0,0,.1)}

.fg{margin-bottom:16px}
.fg label{display:block;font-size:.73rem;font-weight:500;color:var(--navy);letter-spacing:.03em;margin-bottom:5px}
.iw{position:relative}
.iw>svg:first-child{position:absolute;left:13px;top:50%;transform:translateY(-50%);width:15px;height:15px;color:var(--muted);pointer-events:none}
.iw input{width:100%;padding:12px 13px 12px 40px;border:1.5px solid var(--border);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:.86rem;color:var(--navy);background:var(--ice2);outline:none;transition:border-color .2s,background .2s,box-shadow .2s}
.iw input:focus{border-color:var(--sky);background:#fff;box-shadow:0 0 0 4px rgba(59,158,255,.1)}
.tgp{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--muted);display:flex;align-items:center}
.tgp svg{width:15px;height:15px}
.errmsg{display:none;align-items:center;gap:7px;background:#fff0f0;border:1px solid #f7c5c5;border-radius:8px;padding:9px 13px;font-size:.76rem;color:var(--error);margin-bottom:14px}
.errmsg.show{display:flex}
.errmsg svg{width:14px;height:14px;flex-shrink:0}
.btnp{width:100%;padding:13px;background:linear-gradient(135deg,var(--blue),#0d3d7a);color:#fff;border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:.88rem;font-weight:500;cursor:pointer;box-shadow:0 4px 20px rgba(26,95,168,.35);transition:transform .15s}
.btnp:hover{transform:translateY(-1px)}
.btnp:disabled{opacity:.6;cursor:not-allowed;transform:none}
.btnp .sp{display:none;width:15px;height:15px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;margin:0 auto}
.btnp.loading .bt{display:none}
.btnp.loading .sp{display:block}

/* ═══════ APP SHELL ═══════ */
#appShell{display:none;height:100vh;background:var(--ice2)}
#appShell.show{display:flex}

.sidebar{width:var(--sw);background:var(--navy);height:100vh;display:flex;flex-direction:column;flex-shrink:0;position:relative;z-index:50;transition:transform .3s ease}
.snav{flex:1;padding:12px 8px;overflow-y:auto}
.ni{display:flex;align-items:center;gap:9px;padding:9px 10px;border-radius:8px;font-size:.79rem;color:rgba(255,255,255,.5);cursor:pointer;margin-bottom:1px;transition:background .15s,color .15s;user-select:none}
.ni.active{background:rgba(59,158,255,.15);color:var(--sky)}

.main-area{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.topbar{background:#fff;padding:0 18px;height:var(--th);display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);flex-shrink:0}
.ca{flex:1;overflow-y:auto;padding:18px}
.page{display:none;animation:fadeUp .3s ease}
.page.active{display:block}

/* ═══════ NEW: GROUPS STYLING ═══════ */
.group-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    background: #fff;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid var(--border);
    overflow-x: auto;
}
.group-tag {
    padding: 6px 12px;
    border-radius: 20px;
    background: var(--ice2);
    color: var(--muted);
    font-size: 0.75rem;
    cursor: pointer;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
    border: 1px solid transparent;
}
.group-tag.active {
    background: var(--sky);
    color: #fff;
}
.group-tag:hover {
    border-color: var(--sky);
}
.group-del {
    font-size: 14px;
    color: var(--error);
    cursor: pointer;
    opacity: 0.6;
}
.group-del:hover { opacity: 1; }

/* Existing components... */
.card{background:#fff;border-radius:13px;border:1px solid var(--border);overflow:hidden}
.fbar{display:flex;align-items:center;gap:7px;margin-bottom:14px;flex-wrap:wrap}
.fsearch{display:flex;align-items:center;gap:6px;background:#fff;border:1.5px solid var(--border);border-radius:8px;padding:7px 12px;flex:1;min-width:160px;max-width:280px}
.btn-add{display:flex;align-items:center;gap:6px;background:linear-gradient(135deg,var(--blue),#0d3d7a);color:#fff;border:none;border-radius:9px;padding:9px 15px;font-family:'DM Sans',sans-serif;font-size:.79rem;font-weight:500;cursor:pointer}

.pg{display:grid;grid-template-columns:repeat(auto-fill,minmax(268px,1fr));gap:12px}
.pcard{background:#fff;border-radius:12px;border:1px solid var(--border);padding:16px;cursor:pointer}
.mf{margin-bottom:14px}
.mf label{display:block;font-size:.71rem;font-weight:500;color:var(--navy);margin-bottom:5px}
.mf input, .mf select { width:100%; padding:9px 11px; border:1.5px solid var(--border); border-radius:8px; background:var(--ice2); }

@keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
</style>
</head>
<body>

<div id="loginPage">
  <div class="grid-bg"></div>
  <div class="lc">
    <div class="ll">
        <div>
            <div class="bicon"><svg fill="none" viewBox="0 0 24 24" stroke="white"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg></div>
            <div class="bname">OrthoAssist</div>
            <div class="bsub">Practice Intelligence</div>
        </div>
    </div>
    <div class="lr">
        <h2 class="fti">Welcome Back</h2>
        <p class="fsu">Enter credentials to access your dashboard</p>
        <div class="fg"><input type="email" id="logEmail" placeholder="Email" class="iw"></div>
        <div class="fg"><input type="password" id="logPass" placeholder="Password" class="iw"></div>
        <button class="btnp" onclick="doLogin()">Login</button>
    </div>
  </div>
</div>

<div id="appShell">
  <div class="sidebar">
    <div class="snav">
      <div class="ni active" onclick="showPage('patients')">Patients</div>
      <div class="ni" onclick="showPage('appointments')">Appointments</div>
    </div>
  </div>
  <div class="main-area">
    <div class="topbar"><h2 class="tbt">OrthoAssist</h2></div>
    <div class="ca">
      <div id="page-patients" class="page active">
        <div class="ph">
            <h2 class="phead">Patients</h2>
            <button class="btn-add" onclick="openAddPatientModal()">+ New Patient</button>
        </div>
        
        <div class="group-bar">
            <div class="group-tag active" onclick="filterByGroup('all')" id="tag-all">All Patients</div>
            <div id="dynamicGroups" style="display:flex; gap:10px;"></div>
            <div style="display:flex; gap:5px; margin-left:auto;">
                <input type="text" id="newGrpName" placeholder="New Group..." style="padding:5px; border-radius:5px; border:1px solid var(--border); font-size:0.7rem;">
                <button class="btn-add" onclick="createGroup()" style="padding:5px 10px;">+</button>
            </div>
        </div>

        <div class="fbar">
            <div class="fsearch"><input type="text" placeholder="Search patients..." oninput="searchPatients(this.value)"></div>
        </div>
        <div class="pg" id="patientGrid"></div>
      </div>
    </div>
  </div>
</div>

<div id="modal-patient" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div class="card" style="width:400px; padding:20px;">
        <h3 style="margin-bottom:15px;">Add/Edit Patient</h3>
        <div class="mf"><label>Full Name</label><input type="text" id="patName"></div>
        <div class="mf"><label>Phone</label><input type="text" id="patPhone"></div>
        <div class="mf">
            <label>Sub-Group</label>
            <select id="patGroupId">
                <option value="">No Group</option>
            </select>
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="savePatient()" class="btn-save">Save</button>
            <button onclick="closeModal()" class="btn-cancel">Cancel</button>
        </div>
    </div>
</div>

<script>
let currentGroupFilter = 'all';

// --- PAGE NAVIGATION ---
function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-' + id).classList.add('active');
}

// --- GROUP LOGIC ---
async function createGroup() {
    const name = document.getElementById('newGrpName').value;
    if(!name) return;
    const ref = window._FB.doc(window._FB.collection(window._FB.db, 'groups'));
    await window._FB.setDoc(ref, { name, createdAt: window._FB.serverTimestamp() });
    document.getElementById('newGrpName').value = '';
    loadGroups();
}

async function loadGroups() {
    const snap = await window._FB.getDocs(window._FB.collection(window._FB.db, 'groups'));
    const container = document.getElementById('dynamicGroups');
    const select = document.getElementById('patGroupId');
    
    let html = '';
    let options = '<option value="">No Group</option>';
    
    snap.forEach(doc => {
        const g = doc.data();
        html += `<div class="group-tag" id="tag-${doc.id}" onclick="filterByGroup('${doc.id}')">
                    ${g.name} 
                    <span class="group-del" onclick="deleteGroup(event, '${doc.id}')">&times;</span>
                 </div>`;
        options += `<option value="${doc.id}">${g.name}</option>`;
    });
    
    container.innerHTML = html;
    select.innerHTML = options;
}

async function deleteGroup(e, id) {
    e.stopPropagation();
    if(!confirm("Delete group? Patients will be unassigned.")) return;
    await window._FB.deleteDoc(window._FB.doc(window._FB.db, 'groups', id));
    loadGroups();
}

function filterByGroup(id) {
    currentGroupFilter = id;
    document.querySelectorAll('.group-tag').forEach(t => t.classList.remove('active'));
    document.getElementById('tag-' + id).classList.add('active');
    loadPatients();
}

// --- PATIENT LOGIC ---
function openAddPatientModal() {
    document.getElementById('modal-patient').style.display = 'flex';
}
function closeModal() {
    document.getElementById('modal-patient').style.display = 'none';
}

async function savePatient() {
    const name = document.getElementById('patName').value;
    const phone = document.getElementById('patPhone').value;
    const groupId = document.getElementById('patGroupId').value;
    
    const ref = window._FB.doc(window._FB.collection(window._FB.db, 'patients'));
    await window._FB.setDoc(ref, { name, phone, groupId, createdAt: window._FB.serverTimestamp() });
    closeModal();
    loadPatients();
}

async function loadPatients() {
    let q = window._FB.collection(window._FB.db, 'patients');
    if(currentGroupFilter !== 'all') {
        q = window._FB.query(q, window._FB.where('groupId', '==', currentGroupFilter));
    }
    
    const snap = await window._FB.getDocs(q);
    const grid = document.getElementById('patientGrid');
    grid.innerHTML = '';
    
    snap.forEach(doc => {
        const p = doc.data();
        grid.innerHTML += `
            <div class="pcard">
                <div class="pname">${p.name}</div>
                <div class="pmeta">${p.phone || 'No phone'}</div>
            </div>`;
    });
}

// --- AUTH ---
function doLogin() {
    // Demo login bypass for brevity
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('appShell').classList.add('show');
    loadGroups();
    loadPatients();
}

window.addEventListener('fb-ready', () => {
    console.log("Firebase Ready in UI");
});
</script>

</body>
</html>
