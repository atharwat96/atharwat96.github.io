<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>OrthoAssist — Practice Management</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600&family=DM+Sans:ital,wght@0,300;0,400;0,500;1,300&display=swap" rel="stylesheet">
<style>
:root {
  --navy:#0a2540; --navy2:#0d2f4f; --blue:#1a5fa8; --sky:#3b9eff;
  --ice:#e8f4fd; --ice2:#f4f9ff; --white:#ffffff;
  --muted:#8da4be; --muted2:#b8cfe4; --text:#1a2e42; --border:#ddeaf6;
  --error:#d64045; --success:#2e9e6b; --warning:#e8930a;
  --sidebar-w:240px; --topbar-h:60px;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;overflow:hidden}
body{font-family:'DM Sans',sans-serif;background:var(--navy);color:var(--text)}

/* ─── LOGIN ─────────────────────────────── */
#loginPage{min-height:100vh;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
#loginPage::before{content:'';position:fixed;top:-30%;right:-15%;width:70vw;height:70vw;border-radius:50%;background:radial-gradient(circle,rgba(59,158,255,.12),transparent 70%);pointer-events:none}
#loginPage::after{content:'';position:fixed;bottom:-20%;left:-10%;width:50vw;height:50vw;border-radius:50%;background:radial-gradient(circle,rgba(26,95,168,.18),transparent 70%);pointer-events:none}
.grid-bg{position:fixed;inset:0;background-image:linear-gradient(rgba(59,158,255,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(59,158,255,.04) 1px,transparent 1px);background-size:60px 60px;pointer-events:none}
.lc{display:flex;width:min(900px,95vw);min-height:520px;position:relative;z-index:1;animation:fadeUp .7s ease both}
.ll{flex:1;background:linear-gradient(145deg,var(--blue),#0d3d7a);border-radius:20px 0 0 20px;padding:44px 36px;display:flex;flex-direction:column;justify-content:space-between;position:relative;overflow:hidden}
.ll::before{content:'';position:absolute;top:-40px;right:-40px;width:200px;height:200px;border-radius:50%;border:1px solid rgba(255,255,255,.08)}
.ll::after{content:'';position:absolute;bottom:-60px;left:-60px;width:280px;height:280px;border-radius:50%;border:1px solid rgba(255,255,255,.06)}
.brand{position:relative;z-index:1}
.bicon{width:46px;height:46px;background:rgba(255,255,255,.12);border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:16px;border:1px solid rgba(255,255,255,.15)}
.bicon svg{width:24px;height:24px}
.bname{font-family:'Cormorant Garamond',serif;font-size:1.9rem;font-weight:600;color:#fff;letter-spacing:-.02em;line-height:1}
.bsub{font-size:.68rem;color:rgba(255,255,255,.45);letter-spacing:.12em;text-transform:uppercase;margin-top:5px}
.pi{position:relative;z-index:1}
.pt{font-family:'Cormorant Garamond',serif;font-size:1.5rem;font-weight:300;color:#fff;line-height:1.3;margin-bottom:10px}
.pd{font-size:.8rem;color:rgba(255,255,255,.5);line-height:1.7}
.fl{position:relative;z-index:1;list-style:none}
.fl li{display:flex;align-items:center;gap:9px;font-size:.76rem;color:rgba(255,255,255,.6);padding:5px 0;border-top:1px solid rgba(255,255,255,.06)}
.fl li:last-child{border-bottom:1px solid rgba(255,255,255,.06)}
.dot{width:6px;height:6px;border-radius:50%;background:var(--sky);flex-shrink:0}
.lr{flex:1.1;background:#fff;border-radius:0 20px 20px 0;padding:44px 40px;display:flex;flex-direction:column;justify-content:center}
.fey{font-size:.68rem;letter-spacing:.15em;text-transform:uppercase;color:var(--sky);font-weight:500;margin-bottom:7px}
.fti{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:600;color:var(--navy);letter-spacing:-.02em}
.fsu{font-size:.8rem;color:var(--muted);margin-top:5px;margin-bottom:28px}
.fg{margin-bottom:18px}
.fg label{display:block;font-size:.73rem;font-weight:500;color:var(--navy);letter-spacing:.03em;margin-bottom:6px}
.iw{position:relative}
.iw>svg:first-child{position:absolute;left:13px;top:50%;transform:translateY(-50%);width:15px;height:15px;color:var(--muted);pointer-events:none}
.iw input{width:100%;padding:12px 13px 12px 40px;border:1.5px solid var(--border);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:.86rem;color:var(--navy);background:var(--ice2);outline:none;transition:border-color .2s,background .2s,box-shadow .2s}
.iw input:focus{border-color:var(--sky);background:#fff;box-shadow:0 0 0 4px rgba(59,158,255,.1)}
.tgp{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--muted);display:flex;align-items:center}
.tgp:hover{color:var(--blue)}
.tgp svg{width:15px;height:15px}
.errmsg{display:none;align-items:center;gap:7px;background:#fff0f0;border:1px solid #f7c5c5;border-radius:8px;padding:9px 13px;font-size:.76rem;color:var(--error);margin-bottom:16px;animation:shake .4s ease}
.errmsg.show{display:flex}
.errmsg svg{width:14px;height:14px;flex-shrink:0}
.btnp{width:100%;padding:13px;background:linear-gradient(135deg,var(--blue),#0d3d7a);color:#fff;border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:.88rem;font-weight:500;cursor:pointer;box-shadow:0 4px 20px rgba(26,95,168,.35);transition:transform .15s,box-shadow .15s}
.btnp:hover{transform:translateY(-1px);box-shadow:0 6px 24px rgba(26,95,168,.45)}
.btnp:disabled{opacity:.6;cursor:not-allowed;transform:none}
.btnp .sp{display:none;width:15px;height:15px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;margin:0 auto}
.btnp.loading .bt{display:none}
.btnp.loading .sp{display:block}
.secnote{margin-top:22px;padding-top:16px;border-top:1px solid var(--border);font-size:.7rem;color:var(--muted);display:flex;align-items:center;gap:6px}
.secnote svg{width:12px;height:12px;color:var(--success)}

/* ─── APP SHELL ──────────────────────────── */
#appShell{display:none;height:100vh;background:var(--ice2)}
#appShell.show{display:flex}

/* ─── SIDEBAR ────────────────────────────── */
.sidebar{width:var(--sidebar-w);background:var(--navy);height:100vh;display:flex;flex-direction:column;flex-shrink:0;position:relative;z-index:50;transition:transform .3s ease}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:49;backdrop-filter:blur(2px)}
.sidebar-logo{padding:24px 20px 18px;border-bottom:1px solid rgba(255,255,255,.06)}
.sidebar-logo .bicon{width:34px;height:34px;border-radius:9px;margin-bottom:12px}
.sidebar-logo .bicon svg{width:18px;height:18px}
.sidebar-logo .bname{font-size:1.25rem}
.sidebar-logo .bsub{font-size:.6rem}
.snav{flex:1;padding:14px 10px;overflow-y:auto}
.nsl{font-size:.58rem;letter-spacing:.14em;text-transform:uppercase;color:rgba(255,255,255,.28);font-weight:500;padding:10px 10px 5px}
.ni{display:flex;align-items:center;gap:10px;padding:9px 11px;border-radius:9px;font-size:.8rem;color:rgba(255,255,255,.52);cursor:pointer;margin-bottom:2px;transition:background .15s,color .15s;user-select:none}
.ni svg{width:16px;height:16px;flex-shrink:0}
.ni:hover{background:rgba(255,255,255,.06);color:rgba(255,255,255,.82)}
.ni.active{background:rgba(59,158,255,.15);color:var(--sky)}
.ni .nbadge{margin-left:auto;background:var(--sky);color:#fff;font-size:.62rem;padding:1px 6px;border-radius:20px;font-weight:500}
.susr{padding:14px 14px 18px;border-top:1px solid rgba(255,255,255,.06)}
.ucard{display:flex;align-items:center;gap:10px}
.uavt{width:34px;height:34px;background:linear-gradient(135deg,var(--blue),var(--sky));border-radius:9px;display:flex;align-items:center;justify-content:center;font-family:'Cormorant Garamond',serif;font-size:.95rem;font-weight:600;color:#fff;flex-shrink:0}
.uname{font-size:.8rem;font-weight:500;color:rgba(255,255,255,.82)}
.urole{font-size:.68rem;color:rgba(255,255,255,.32)}
.lbtn{margin-left:auto;background:none;border:none;cursor:pointer;color:rgba(255,255,255,.28);transition:color .15s}
.lbtn:hover{color:rgba(255,255,255,.7)}
.lbtn svg{width:15px;height:15px}

/* ─── MAIN AREA ──────────────────────────── */
.main-area{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0}
.topbar{background:#fff;padding:0 20px;height:var(--topbar-h);display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);flex-shrink:0}
.ham{display:none;background:none;border:1.5px solid var(--border);border-radius:8px;width:34px;height:34px;cursor:pointer;align-items:center;justify-content:center;color:var(--muted);flex-shrink:0}
.ham svg{width:16px;height:16px}
.tb-title{font-family:'Cormorant Garamond',serif;font-size:1.3rem;font-weight:600;color:var(--navy)}
.tb-date{font-size:.72rem;color:var(--muted)}
.tb-sp{flex:1}
.tb-search{display:flex;align-items:center;gap:7px;background:var(--ice2);border:1.5px solid var(--border);border-radius:9px;padding:7px 12px;width:200px}
.tb-search svg{width:14px;height:14px;color:var(--muted);flex-shrink:0}
.tb-search input{border:none;outline:none;background:none;font-family:'DM Sans',sans-serif;font-size:.8rem;color:var(--text);width:100%}
.tb-search input::placeholder{color:var(--muted)}
.tbbtn{width:34px;height:34px;border:1.5px solid var(--border);border-radius:8px;background:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--muted);transition:border-color .15s,color .15s;position:relative;flex-shrink:0}
.tbbtn:hover{border-color:var(--sky);color:var(--sky)}
.tbbtn svg{width:15px;height:15px}
.ndot::after{content:'';position:absolute;top:5px;right:5px;width:7px;height:7px;border-radius:50%;background:var(--sky);border:2px solid #fff}
.content-area{flex:1;overflow-y:auto;padding:20px}
.page{display:none;animation:fadeUp .3s ease}
.page.active{display:block}

/* ─── DASHBOARD ──────────────────────────── */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:18px}
.sc{background:#fff;border-radius:13px;padding:18px 18px 14px;border:1px solid var(--border);position:relative;overflow:hidden;transition:transform .15s,box-shadow .15s;cursor:default}
.sc:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(26,95,168,.1)}
.sc::after{content:'';position:absolute;top:0;left:0;height:3px;width:100%}
.sc.bl::after{background:linear-gradient(90deg,var(--blue),var(--sky))}
.sc.gr::after{background:linear-gradient(90deg,#2e9e6b,#43c98b)}
.sc.or::after{background:linear-gradient(90deg,#e8930a,#f5b43e)}
.sc.rd::after{background:linear-gradient(90deg,#d64045,#f07277)}
.si{width:36px;height:36px;border-radius:9px;display:flex;align-items:center;justify-content:center;margin-bottom:12px}
.si svg{width:17px;height:17px}
.si.bl{background:rgba(59,158,255,.12);color:var(--blue)}
.si.gr{background:rgba(46,158,107,.12);color:#2e9e6b}
.si.or{background:rgba(232,147,10,.12);color:#e8930a}
.si.rd{background:rgba(214,64,69,.12);color:#d64045}
.sv{font-family:'Cormorant Garamond',serif;font-size:2rem;font-weight:600;color:var(--navy);line-height:1;margin-bottom:3px}
.sl{font-size:.75rem;color:var(--muted)}
.str{font-size:.7rem;color:var(--success);margin-top:6px}
.dash-grid{display:grid;grid-template-columns:1fr 340px;gap:16px}
.card{background:#fff;border-radius:13px;border:1px solid var(--border);overflow:hidden}
.card-hd{padding:16px 20px 12px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.card-ti{font-family:'Cormorant Garamond',serif;font-size:1.05rem;font-weight:600;color:var(--navy)}
.card-ac{font-size:.73rem;color:var(--sky);cursor:pointer;font-weight:500}
.card-ac:hover{text-decoration:underline}
.card-bd{padding:14px 20px}
.al{list-style:none}
.ai{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)}
.ai:last-child{border-bottom:none}
.at{font-size:.72rem;color:var(--muted);width:50px;flex-shrink:0;font-weight:500}
.aa{width:32px;height:32px;border-radius:8px;background:linear-gradient(135deg,var(--blue),var(--sky));display:flex;align-items:center;justify-content:center;font-family:'Cormorant Garamond',serif;font-size:.85rem;color:#fff;font-weight:600;flex-shrink:0}
.ain{flex:1;min-width:0}
.an{font-size:.82rem;font-weight:500;color:var(--text)}
.ar{font-size:.72rem;color:var(--muted);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.sb{font-size:.66rem;font-weight:500;padding:3px 9px;border-radius:20px;flex-shrink:0}
.s-confirmed{background:rgba(46,158,107,.1);color:#2e9e6b}
.s-pending{background:rgba(232,147,10,.1);color:#e8930a}
.s-cancelled{background:rgba(214,64,69,.1);color:#d64045}
.acl{list-style:none}
.aci{display:flex;align-items:flex-start;gap:11px;padding:9px 0;border-bottom:1px solid var(--border)}
.aci:last-child{border-bottom:none}
.acd{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:5px}
.acd.bl{background:var(--sky)}
.acd.gr{background:var(--success)}
.acd.or{background:var(--warning)}
.act{font-size:.78rem;color:var(--text);line-height:1.5}
.act span{font-weight:500;color:var(--navy)}
.actime{font-size:.68rem;color:var(--muted);margin-top:2px}
.sgi{display:flex;align-items:center;gap:11px;padding:9px 0;border-bottom:1px solid var(--border)}
.sgi:last-child{border-bottom:none}
.sgd{text-align:center;width:38px;flex-shrink:0}
.sgdd{font-family:'Cormorant Garamond',serif;font-size:1.3rem;font-weight:600;color:var(--blue);line-height:1}
.sgdm{font-size:.62rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted)}
.sgi-info{flex:1}
.sgi-name{font-size:.8rem;font-weight:500;color:var(--text)}
.sgi-proc{font-size:.72rem;color:var(--muted);margin-top:1px}
.sgi-time{font-size:.7rem;color:var(--muted)}

/* ─── PATIENTS ───────────────────────────── */
.ph{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:10px;flex-wrap:wrap}
.phead{font-family:'Cormorant Garamond',serif;font-size:1.55rem;font-weight:600;color:var(--navy)}
.psub{font-size:.77rem;color:var(--muted);margin-top:2px}
.btn-add{display:flex;align-items:center;gap:7px;background:linear-gradient(135deg,var(--blue),#0d3d7a);color:#fff;border:none;border-radius:9px;padding:9px 16px;font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:500;cursor:pointer;box-shadow:0 4px 14px rgba(26,95,168,.3);transition:transform .15s,box-shadow .15s;white-space:nowrap}
.btn-add:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(26,95,168,.4)}
.btn-add svg{width:14px;height:14px}
.fbar{display:flex;align-items:center;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.fsearch{display:flex;align-items:center;gap:7px;background:#fff;border:1.5px solid var(--border);border-radius:9px;padding:8px 13px;flex:1;min-width:180px;max-width:300px}
.fsearch svg{width:14px;height:14px;color:var(--muted);flex-shrink:0}
.fsearch input{border:none;outline:none;background:none;font-family:'DM Sans',sans-serif;font-size:.8rem;color:var(--text);width:100%}
.fbtn{padding:8px 14px;border-radius:9px;font-size:.77rem;font-weight:500;border:1.5px solid var(--border);background:#fff;color:var(--muted);cursor:pointer;transition:all .15s;white-space:nowrap}
.fbtn.active{border-color:var(--sky);background:rgba(59,158,255,.08);color:var(--blue)}
.pg{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.pcard{background:#fff;border-radius:13px;border:1px solid var(--border);padding:18px;cursor:pointer;transition:transform .15s,box-shadow .15s,border-color .15s}
.pcard:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(26,95,168,.1);border-color:rgba(59,158,255,.3)}
.pct{display:flex;align-items:flex-start;gap:12px;margin-bottom:12px}
.pav{width:42px;height:42px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-family:'Cormorant Garamond',serif;font-size:1rem;font-weight:600;color:#fff;flex-shrink:0}
.pav.c1{background:linear-gradient(135deg,#1a5fa8,#3b9eff)}
.pav.c2{background:linear-gradient(135deg,#2e9e6b,#43c98b)}
.pav.c3{background:linear-gradient(135deg,#7c4dff,#b388ff)}
.pav.c4{background:linear-gradient(135deg,#e8930a,#f5c842)}
.pav.c5{background:linear-gradient(135deg,#d64045,#f07277)}
.pname{font-size:.92rem;font-weight:500;color:var(--navy)}
.pmeta{font-size:.72rem;color:var(--muted);margin-top:2px}
.pid{font-size:.68rem;color:var(--muted2);margin-top:1px;font-family:monospace;letter-spacing:.04em}
.pdiag{background:var(--ice2);border-radius:7px;padding:8px 11px;font-size:.76rem;color:var(--text);margin-bottom:11px;border-left:3px solid var(--blue)}
.pdl{font-size:.65rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);margin-bottom:2px}
.pcf{display:flex;align-items:center;justify-content:space-between}
.pvs{font-size:.72rem;color:var(--muted)}
.pvs span{color:var(--navy);font-weight:500}
.pbtn{font-size:.72rem;color:var(--sky);font-weight:500;background:none;border:none;cursor:pointer;display:flex;align-items:center;gap:3px}
.pbtn:hover{text-decoration:underline}
.pbtn svg{width:12px;height:12px}

/* ─── PATIENT DETAIL PANEL ───────────────── */
.overlay{position:fixed;inset:0;background:rgba(10,37,64,.5);backdrop-filter:blur(4px);z-index:200;display:none;align-items:stretch;justify-content:flex-end}
.overlay.show{display:flex;animation:fadeIn .2s ease}
.dpanel{width:min(560px,100vw);height:100vh;background:#fff;overflow-y:auto;display:flex;flex-direction:column;animation:slideLeft .3s ease}
.dpanel-header{padding:20px 24px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:#fff;z-index:10}
.dpanel-tabs{display:flex;gap:4px;background:var(--ice2);border-radius:9px;padding:3px}
.dtab{padding:7px 14px;border-radius:7px;font-size:.77rem;font-weight:500;color:var(--muted);cursor:pointer;transition:all .15s;border:none;background:none;white-space:nowrap}
.dtab.active{background:#fff;color:var(--navy);box-shadow:0 1px 4px rgba(0,0,0,.1)}
.dclose{width:32px;height:32px;border-radius:8px;border:1.5px solid var(--border);background:none;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--muted);transition:all .15s;flex-shrink:0}
.dclose:hover{border-color:var(--error);color:var(--error)}
.dclose svg{width:14px;height:14px}
.dpanel-body{flex:1;padding:20px 24px}
.dp-tab-content{display:none}
.dp-tab-content.active{display:block}
.ds{margin-bottom:20px}
.dst{font-size:.65rem;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);font-weight:500;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.dst::after{content:'';flex:1;height:1px;background:var(--border)}
.dgr{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.df label{font-size:.68rem;color:var(--muted);margin-bottom:2px;display:block}
.df p{font-size:.82rem;color:var(--text)}
.df p.hi{color:var(--navy);font-weight:500}
.vi{padding:9px 0;border-bottom:1px solid var(--border);display:flex;gap:11px;align-items:flex-start}
.vi:last-child{border-bottom:none}
.vdb{background:var(--ice2);border-radius:7px;padding:4px 9px;text-align:center;flex-shrink:0;min-width:46px}
.vdb .vd{font-family:'Cormorant Garamond',serif;font-size:1.05rem;font-weight:600;color:var(--blue)}
.vdb .vm{font-size:.62rem;color:var(--muted);text-transform:uppercase}
.vi-type{font-size:.8rem;font-weight:500;color:var(--text)}
.vi-note{font-size:.73rem;color:var(--muted);margin-top:1px}

/* Notes editor */
.notes-editor{display:flex;flex-direction:column;gap:14px}
.note-item{background:var(--ice2);border-radius:10px;padding:14px;border:1px solid var(--border)}
.note-item-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.note-item-date{font-size:.7rem;color:var(--muted)}
.note-item-type{font-size:.7rem;color:var(--blue);font-weight:500;background:rgba(59,158,255,.1);padding:2px 8px;border-radius:20px}
.note-item-text{font-size:.82rem;color:var(--text);line-height:1.6}
.note-new{margin-top:4px}
.note-new label{font-size:.72rem;font-weight:500;color:var(--navy);margin-bottom:6px;display:block}
.note-new select,.note-new textarea{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:9px;font-family:'DM Sans',sans-serif;font-size:.82rem;color:var(--text);background:#fff;outline:none;transition:border-color .2s,box-shadow .2s;resize:vertical}
.note-new textarea{min-height:90px}
.note-new select,.note-new textarea{display:block;margin-bottom:10px}
.note-new select:focus,.note-new textarea:focus{border-color:var(--sky);box-shadow:0 0 0 3px rgba(59,158,255,.1)}
.note-row{display:flex;gap:8px;align-items:flex-end}
.note-row .note-new{flex:1}

/* Imaging */
.img-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:14px}
.img-placeholder{background:var(--ice2);border:2px dashed var(--border);border-radius:10px;aspect-ratio:4/3;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;cursor:pointer;transition:border-color .2s,background .2s}
.img-placeholder:hover{border-color:var(--sky);background:rgba(59,158,255,.04)}
.img-placeholder svg{width:24px;height:24px;color:var(--muted2)}
.img-placeholder span{font-size:.72rem;color:var(--muted);text-align:center}
.img-item{background:var(--navy);border-radius:10px;aspect-ratio:4/3;display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;overflow:hidden}
.img-item img{width:100%;height:100%;object-fit:cover}
.img-item-info{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(10,37,64,.8));padding:8px 10px}
.img-item-label{font-size:.68rem;color:#fff;font-weight:500}
.img-item-date{font-size:.62rem;color:rgba(255,255,255,.6)}
.img-upload-btn{display:flex;align-items:center;gap:7px;background:var(--ice2);border:1.5px dashed var(--border);border-radius:9px;padding:10px 16px;font-size:.8rem;color:var(--muted);cursor:pointer;width:100%;justify-content:center;transition:all .2s}
.img-upload-btn:hover{border-color:var(--sky);color:var(--blue);background:rgba(59,158,255,.05)}
.img-upload-btn svg{width:15px;height:15px}

/* ─── AI ASSISTANT ───────────────────────── */
#aiPanel{position:fixed;inset:0;z-index:300;display:none;align-items:flex-end;justify-content:flex-end;padding:0}
#aiPanel.show{display:flex;animation:fadeIn .2s ease}
.ai-panel-bg{position:absolute;inset:0;background:rgba(10,37,64,.4);backdrop-filter:blur(3px)}
.ai-box{position:relative;z-index:1;width:min(440px,100vw);height:min(640px,100vh);background:#fff;border-radius:20px 20px 0 0;display:flex;flex-direction:column;overflow:hidden;animation:slideUp .3s ease;box-shadow:0 -8px 40px rgba(10,37,64,.2)}
@media(min-width:600px){.ai-box{border-radius:20px;margin:20px;height:min(640px,calc(100vh - 40px))}}
.ai-header{padding:18px 20px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.ai-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--blue),var(--sky));border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.ai-icon svg{width:18px;height:18px;color:#fff}
.ai-title{font-family:'Cormorant Garamond',serif;font-size:1.15rem;font-weight:600;color:var(--navy)}
.ai-sub{font-size:.72rem;color:var(--muted);margin-top:1px}
.ai-close{margin-left:auto;background:none;border:none;cursor:pointer;color:var(--muted);display:flex;align-items:center}
.ai-close:hover{color:var(--error)}
.ai-close svg{width:18px;height:18px}
.ai-modes{display:flex;gap:6px;padding:12px 20px;border-bottom:1px solid var(--border)}
.ai-mode{padding:6px 14px;border-radius:7px;font-size:.75rem;font-weight:500;cursor:pointer;border:1.5px solid var(--border);background:#fff;color:var(--muted);transition:all .15s}
.ai-mode.active{border-color:var(--sky);background:rgba(59,158,255,.08);color:var(--blue)}
.ai-patient-sel{padding:0 20px 12px;border-bottom:1px solid var(--border)}
.ai-patient-sel select{width:100%;padding:9px 12px;border:1.5px solid var(--border);border-radius:9px;font-family:'DM Sans',sans-serif;font-size:.82rem;color:var(--text);background:#fff;outline:none;margin-top:10px}
.ai-patient-sel select:focus{border-color:var(--sky);box-shadow:0 0 0 3px rgba(59,158,255,.1)}
.ai-patient-sel label{font-size:.72rem;font-weight:500;color:var(--navy);display:block;margin-top:12px}
.ai-chat{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:12px}
.ai-msg{max-width:88%;padding:11px 14px;border-radius:12px;font-size:.82rem;line-height:1.6}
.ai-msg.user{background:linear-gradient(135deg,var(--blue),#0d3d7a);color:#fff;align-self:flex-end;border-radius:12px 12px 4px 12px}
.ai-msg.ai{background:var(--ice2);color:var(--text);align-self:flex-start;border:1px solid var(--border);border-radius:12px 12px 12px 4px}
.ai-msg.ai.loading{color:var(--muted);font-style:italic}
.ai-input-area{padding:14px 20px;border-top:1px solid var(--border);display:flex;gap:8px;align-items:flex-end}
.ai-input{flex:1;padding:10px 13px;border:1.5px solid var(--border);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:.82rem;color:var(--text);background:var(--ice2);outline:none;resize:none;min-height:40px;max-height:100px;transition:border-color .2s}
.ai-input:focus{border-color:var(--sky);background:#fff}
.ai-send{width:38px;height:38px;background:linear-gradient(135deg,var(--blue),#0d3d7a);border:none;border-radius:9px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 3px 10px rgba(26,95,168,.3);transition:transform .15s}
.ai-send:hover{transform:scale(1.05)}
.ai-send svg{width:16px;height:16px;color:#fff}
.ai-quick{display:flex;gap:6px;padding:0 20px 12px;flex-wrap:wrap}
.ai-qbtn{padding:5px 12px;border-radius:7px;font-size:.72rem;color:var(--blue);background:rgba(59,158,255,.08);border:1px solid rgba(59,158,255,.2);cursor:pointer;transition:all .15s;white-space:nowrap}
.ai-qbtn:hover{background:rgba(59,158,255,.15)}

/* ─── APPOINTMENTS ───────────────────────── */
.appt-layout{display:grid;grid-template-columns:1fr 320px;gap:16px;align-items:start}
.wnav{display:flex;align-items:center;gap:9px;margin-bottom:16px}
.wnbtn{width:30px;height:30px;border-radius:7px;border:1.5px solid var(--border);background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--muted);transition:all .15s}
.wnbtn:hover{border-color:var(--sky);color:var(--sky)}
.wnbtn svg{width:13px;height:13px}
.wlabel{font-family:'Cormorant Garamond',serif;font-size:1.05rem;font-weight:600;color:var(--navy)}
.dcols{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.dch{text-align:center;padding:9px 4px;border-radius:9px;margin-bottom:8px}
.dch.today{background:rgba(59,158,255,.1)}
.dch .dow{font-size:.66rem;text-transform:uppercase;letter-spacing:.1em;color:var(--muted)}
.dch .dd{font-family:'Cormorant Garamond',serif;font-size:1.3rem;font-weight:600;color:var(--navy);line-height:1;margin-top:1px}
.dch.today .dd{color:var(--blue)}
.ablk{border-radius:9px;padding:9px 10px;margin-bottom:7px;cursor:pointer;border-left:3px solid transparent;transition:transform .15s}
.ablk:hover{transform:translateY(-1px)}
.ablk.confirmed{background:rgba(46,158,107,.08);border-color:var(--success)}
.ablk.pending{background:rgba(232,147,10,.08);border-color:var(--warning)}
.ablk.cancelled{background:rgba(214,64,69,.06);border-color:var(--error);opacity:.7}
.abt{font-size:.65rem;color:var(--muted);margin-bottom:2px}
.abn{font-size:.75rem;font-weight:500;color:var(--text)}
.abr{font-size:.67rem;color:var(--muted);margin-top:1px}
.abd{font-size:.64rem;color:var(--muted2);margin-top:3px}
.appt-form-card{background:#fff;border-radius:13px;border:1px solid var(--border);overflow:hidden;position:sticky;top:0}
.aff{margin-bottom:14px}
.aff label{display:block;font-size:.72rem;font-weight:500;color:var(--navy);margin-bottom:5px}
.aff input,.aff select,.aff textarea{width:100%;padding:9px 11px;border:1.5px solid var(--border);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:.8rem;color:var(--text);background:var(--ice2);outline:none;transition:border-color .2s,box-shadow .2s}
.aff input:focus,.aff select:focus{border-color:var(--sky);background:#fff;box-shadow:0 0 0 3px rgba(59,158,255,.1)}
.afrow{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.bsub2{width:100%;padding:10px;background:linear-gradient(135deg,var(--blue),#0d3d7a);color:#fff;border:none;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:500;cursor:pointer;box-shadow:0 3px 12px rgba(26,95,168,.3);transition:transform .15s,box-shadow .15s}
.bsub2:hover{transform:translateY(-1px);box-shadow:0 5px 16px rgba(26,95,168,.4)}

/* ─── ADD/EDIT PATIENT MODAL ─────────────── */
.modal-overlay{position:fixed;inset:0;background:rgba(10,37,64,.55);backdrop-filter:blur(4px);z-index:250;display:none;align-items:center;justify-content:center;padding:16px}
.modal-overlay.show{display:flex;animation:fadeIn .2s ease}
.modal-box{background:#fff;border-radius:16px;width:min(540px,100%);max-height:90vh;overflow-y:auto;animation:fadeUp .3s ease}
.modal-header{padding:20px 24px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:#fff;z-index:5}
.modal-title{font-family:'Cormorant Garamond',serif;font-size:1.25rem;font-weight:600;color:var(--navy)}
.modal-body{padding:20px 24px}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;gap:10px;justify-content:flex-end}
.mf{margin-bottom:16px}
.mf label{display:block;font-size:.72rem;font-weight:500;color:var(--navy);margin-bottom:5px}
.mf input,.mf select,.mf textarea{width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:9px;font-family:'DM Sans',sans-serif;font-size:.83rem;color:var(--text);background:var(--ice2);outline:none;transition:border-color .2s,box-shadow .2s}
.mf input:focus,.mf select:focus,.mf textarea:focus{border-color:var(--sky);background:#fff;box-shadow:0 0 0 3px rgba(59,158,255,.1)}
.mrow{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.btn-cancel{padding:10px 20px;border:1.5px solid var(--border);border-radius:9px;background:#fff;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:.83rem;cursor:pointer;transition:all .15s}
.btn-cancel:hover{border-color:var(--error);color:var(--error)}
.btn-save{padding:10px 22px;background:linear-gradient(135deg,var(--blue),#0d3d7a);color:#fff;border:none;border-radius:9px;font-family:'DM Sans',sans-serif;font-size:.83rem;font-weight:500;cursor:pointer;box-shadow:0 3px 12px rgba(26,95,168,.3);transition:transform .15s}
.btn-save:hover{transform:translateY(-1px)}

/* ─── EXPORT ─────────────────────────────── */
.export-bar{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
.exp-btn{display:flex;align-items:center;gap:6px;padding:8px 14px;border:1.5px solid var(--border);border-radius:9px;background:#fff;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:.78rem;cursor:pointer;transition:all .15s;white-space:nowrap}
.exp-btn:hover{border-color:var(--blue);color:var(--blue);background:rgba(26,95,168,.04)}
.exp-btn svg{width:14px;height:14px}

/* ─── FAB ────────────────────────────────── */
.fab{position:fixed;bottom:24px;right:24px;width:52px;height:52px;background:linear-gradient(135deg,var(--blue),#0d3d7a);border:none;border-radius:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 20px rgba(26,95,168,.4);z-index:100;transition:transform .15s,box-shadow .15s}
.fab:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(26,95,168,.5)}
.fab svg{width:22px;height:22px;color:#fff}

/* ─── TOAST ──────────────────────────────── */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(10px);background:var(--navy);color:#fff;padding:11px 18px;border-radius:11px;font-size:.8rem;display:flex;align-items:center;gap:9px;box-shadow:0 8px 28px rgba(0,0,0,.3);z-index:999;opacity:0;transition:opacity .3s,transform .3s;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast svg{width:15px;height:15px;color:#4ecf8e;flex-shrink:0}

/* ─── PRINT STYLES ───────────────────────── */
@media print {
  body>*:not(#printArea){display:none!important}
  #printArea{display:block!important;position:fixed;inset:0;background:#fff;padding:32px;font-family:'DM Sans',sans-serif;overflow:auto}
  #printArea h1{font-family:'Cormorant Garamond',serif;font-size:1.6rem;color:#0a2540;margin-bottom:4px}
  #printArea .pr-meta{font-size:.8rem;color:#8da4be;margin-bottom:20px}
  #printArea .pr-sec{margin-bottom:16px;border-top:1px solid #ddeaf6;padding-top:12px}
  #printArea .pr-sec h2{font-size:.9rem;font-weight:600;color:#0a2540;margin-bottom:8px}
  #printArea .pr-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  #printArea .pr-field label{font-size:.68rem;color:#8da4be;display:block}
  #printArea .pr-field p{font-size:.82rem;color:#1a2e42;font-weight:500}
}
#printArea{display:none}

/* ─── RESPONSIVE ─────────────────────────── */
@media(max-width:768px){
  .sidebar{position:fixed;left:0;top:0;height:100vh;transform:translateX(-100%);z-index:50}
  .sidebar.open{transform:translateX(0)}
  .sidebar-overlay.show{display:block}
  .ham{display:flex}
  .tb-search{display:none}
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .dash-grid{grid-template-columns:1fr}
  .appt-layout{grid-template-columns:1fr}
  .appt-form-card{position:static}
  .dcols{grid-template-columns:repeat(3,1fr)}
  .pg{grid-template-columns:1fr}
  .content-area{padding:14px}
  .fab{bottom:20px;right:16px}
  .export-bar{gap:6px}
}
@media(max-width:480px){
  .stats-grid{grid-template-columns:repeat(2,1fr);gap:10px}
  .dcols{grid-template-columns:repeat(2,1fr)}
  .mrow{grid-template-columns:1fr}
  .lc{flex-direction:column;min-height:auto}
  .ll{display:none}
  .lr{border-radius:20px;padding:36px 24px}
  .modal-body{padding:16px}
  .modal-footer{flex-direction:column}
  .btn-save,.btn-cancel{width:100%;text-align:center}
}

/* ─── ANIMATIONS ─────────────────────────── */
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideLeft{from{transform:translateX(40px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes shake{0%,100%{transform:translateX(0)}20%{transform:translateX(-6px)}60%{transform:translateX(6px)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.pulse{animation:pulse 1.4s ease infinite}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:10px}
</style>
</head>
<body>
<div class="grid-bg"></div>

<!-- ════════ LOGIN ════════ -->
<div id="loginPage">
  <div class="lc">
    <div class="ll">
      <div class="brand">
        <div class="bicon"><svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg></div>
        <div class="bname">OrthoAssist</div>
        <div class="bsub">Practice Management System</div>
      </div>
      <div class="pi">
        <div class="pt">Your intelligent orthopedic practice companion</div>
        <div class="pd">Streamline patient care, appointments, and clinical workflows — all in one secure platform.</div>
      </div>
      <ul class="fl">
        <li><span class="dot"></span>Patient records & history</li>
        <li><span class="dot"></span>Appointment scheduling</li>
        <li><span class="dot"></span>AI-assisted documentation</li>
        <li><span class="dot"></span>Clinical notes & imaging</li>
      </ul>
    </div>
    <div class="lr">
      <div class="fey">Secure Access</div>
      <div class="fti">Welcome back, Doctor</div>
      <div class="fsu">Sign in to access your practice dashboard</div>
      <div class="errmsg" id="loginError">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        <span>Invalid username or password.</span>
      </div>
      <div class="fg">
        <label>Username</label>
        <div class="iw">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
          <input type="text" id="username" placeholder="Enter your username" autocomplete="username"/>
        </div>
      </div>
      <div class="fg">
        <label>Password</label>
        <div class="iw">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          <input type="password" id="password" placeholder="Enter your password" autocomplete="current-password"/>
          <button class="tgp" id="tgpass">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </button>
        </div>
      </div>
      <button class="btnp" id="loginBtn"><span class="bt">Sign In</span><div class="sp"></div></button>
      <div class="secnote">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
        Secured connection · HIPAA-ready design
      </div>
    </div>
  </div>
</div>

<!-- ════════ APP ════════ -->
<div id="appShell">

  <!-- Sidebar overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-logo">
      <div class="bicon"><svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg></div>
      <div class="bname">OrthoAssist</div>
      <div class="bsub">Practice Management</div>
    </div>
    <nav class="snav">
      <div class="nsl">Main</div>
      <div class="ni active" data-page="dashboard"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>Dashboard</div>
      <div class="ni" data-page="patients"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>Patients<span class="nbadge" id="patientBadge">6</span></div>
      <div class="ni" data-page="appointments"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Appointments</div>
      <div class="nsl">Clinical</div>
      <div class="ni" data-page="patients"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Clinical Notes</div>
      <div class="ni" data-page="patients"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="12" cy="12" r="3"/><path d="M12 3v3M12 18v3M3 12h3M18 12h3"/></svg>Imaging</div>
    </nav>
    <div class="susr">
      <div class="ucard">
        <div class="uavt">Dr</div>
        <div><div class="uname">Dr. Physician</div><div class="urole">Orthopedic Surgeon</div></div>
        <button class="lbtn" id="logoutBtn" title="Sign out"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg></button>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="main-area">
    <div class="topbar">
      <button class="ham" id="hamBtn" onclick="openSidebar()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
      <div><div class="tb-title" id="tbTitle">Dashboard</div><div class="tb-date" id="tbDate"></div></div>
      <div class="tb-sp"></div>
      <div class="tb-search"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Search patients…" id="gSearch"/></div>
      <button class="tbbtn ndot" title="Notifications"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg></button>
      <button class="tbbtn" onclick="openAI()" title="AI Assistant"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/><circle cx="9" cy="13" r="1" fill="currentColor"/><circle cx="15" cy="13" r="1" fill="currentColor"/></svg></button>
    </div>

    <div class="content-area">

      <!-- ── DASHBOARD ── -->
      <div class="page active" id="page-dashboard">
        <div class="stats-grid">
          <div class="sc bl"><div class="si bl"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></div><div class="sv" id="statPatients">6</div><div class="sl">Active Patients</div><div class="str">↑ 3 new this month</div></div>
          <div class="sc gr"><div class="si gr"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg></div><div class="sv" id="statToday">6</div><div class="sl">Today's Appointments</div><div class="str">↑ 2 confirmed</div></div>
          <div class="sc or"><div class="si or"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div><div class="sv">3</div><div class="sl">Upcoming Surgeries</div><div class="str">Next: Feb 27</div></div>
          <div class="sc rd"><div class="si rd"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div><div class="sv">2</div><div class="sl">Pending Follow-ups</div><div class="str">Requires attention</div></div>
        </div>
        <div class="dash-grid">
          <div class="card">
            <div class="card-hd"><div class="card-ti">Today's Schedule</div><span class="card-ac" onclick="navigate('appointments')">View all →</span></div>
            <div class="card-bd"><ul class="al" id="todayList"></ul></div>
          </div>
          <div style="display:flex;flex-direction:column;gap:14px">
            <div class="card">
              <div class="card-hd"><div class="card-ti">Upcoming Surgeries</div></div>
              <div class="card-bd">
                <div class="sgi"><div class="sgd"><div class="sgdd">27</div><div class="sgdm">Feb</div></div><div class="sgi-info"><div class="sgi-name">Ahmed Al-Rashidi</div><div class="sgi-proc">Total Knee Replacement</div></div><div class="sgi-time">07:30</div></div>
                <div class="sgi"><div class="sgd"><div class="sgdd">03</div><div class="sgdm">Mar</div></div><div class="sgi-info"><div class="sgi-name">Nadia Khoury</div><div class="sgi-proc">Rotator Cuff Repair</div></div><div class="sgi-time">09:00</div></div>
                <div class="sgi"><div class="sgd"><div class="sgdd">10</div><div class="sgdm">Mar</div></div><div class="sgi-info"><div class="sgi-name">Omar Mansour</div><div class="sgi-proc">Spinal Fusion L4–L5</div></div><div class="sgi-time">08:00</div></div>
              </div>
            </div>
            <div class="card">
              <div class="card-hd"><div class="card-ti">Recent Activity</div></div>
              <div class="card-bd">
                <ul class="acl">
                  <li class="aci"><div class="acd gr"></div><div><div class="act"><span>Fatima Al-Hassan</span> checked in for 09:00 appt</div><div class="actime">8 min ago</div></div></li>
                  <li class="aci"><div class="acd bl"></div><div><div class="act">New X-ray uploaded for <span>Khalid Ibrahim</span></div><div class="actime">32 min ago</div></div></li>
                  <li class="aci"><div class="acd or"></div><div><div class="act"><span>Yusuf Al-Najjar</span> appointment rescheduled</div><div class="actime">1 hr ago</div></div></li>
                  <li class="aci"><div class="acd gr"></div><div><div class="act">Clinical notes finalized for <span>Layla Qasim</span></div><div class="actime">2 hr ago</div></div></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ── PATIENTS ── -->
      <div class="page" id="page-patients">
        <div class="ph">
          <div><div class="phead">Patients</div><div class="psub" id="patSubtitle">6 active patients</div></div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <div class="export-bar" style="margin:0">
              <button class="exp-btn" onclick="exportPatientCSV()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export CSV</button>
            </div>
            <button class="btn-add" onclick="openAddPatient()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add Patient</button>
          </div>
        </div>
        <div class="fbar">
          <div class="fsearch"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><input type="text" placeholder="Search patients…" id="patSearch" oninput="filterPats(this.value)"/></div>
          <button class="fbtn active" onclick="filterBy('all',this)">All</button>
          <button class="fbtn" onclick="filterBy('knee',this)">Knee</button>
          <button class="fbtn" onclick="filterBy('spine',this)">Spine</button>
          <button class="fbtn" onclick="filterBy('shoulder',this)">Shoulder</button>
        </div>
        <div class="pg" id="pGrid"></div>
      </div>

      <!-- ── APPOINTMENTS ── -->
      <div class="page" id="page-appointments">
        <div class="ph">
          <div><div class="phead">Appointments</div><div class="psub" id="apptSub"></div></div>
          <div class="export-bar" style="margin:0">
            <button class="exp-btn" onclick="exportApptCSV()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Export</button>
          </div>
        </div>
        <div class="appt-layout">
          <div>
            <div class="wnav">
              <button class="wnbtn" onclick="changeWeek(-1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg></button>
              <div class="wlabel" id="weekLabel"></div>
              <button class="wnbtn" onclick="changeWeek(1)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></button>
            </div>
            <div class="dcols" id="weekCols"></div>
          </div>
          <div>
            <div class="appt-form-card">
              <div class="card-hd"><div class="card-ti">New Appointment</div></div>
              <div style="padding:16px">
                <div class="aff"><label>Patient</label><select id="naPat"><option value="">Select patient…</option></select></div>
                <div class="aff"><label>Reason / Procedure</label><input type="text" id="naReason" placeholder="e.g. Follow-up, Consultation…"/></div>
                <div class="afrow">
                  <div class="aff"><label>Date</label><input type="date" id="naDate"/></div>
                  <div class="aff"><label>Time</label><input type="time" id="naTime"/></div>
                </div>
                <div class="afrow">
                  <div class="aff"><label>Duration</label><select id="naDur"><option value="15">15 min</option><option value="30" selected>30 min</option><option value="45">45 min</option><option value="60">60 min</option><option value="90">90 min</option></select></div>
                  <div class="aff"><label>Status</label><select id="naStatus"><option value="confirmed">Confirmed</option><option value="pending">Pending</option></select></div>
                </div>
                <button class="bsub2" onclick="addAppt()">Schedule Appointment</button>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /content-area -->
  </div><!-- /main-area -->
</div><!-- /appShell -->

<!-- ════════ PATIENT DETAIL OVERLAY ════════ -->
<div class="overlay" id="patOverlay" onclick="closePat(event)">
  <div class="dpanel" id="dPanel">
    <div class="dpanel-header">
      <div class="dpanel-tabs">
        <button class="dtab active" onclick="switchDTab('info',this)">Info</button>
        <button class="dtab" onclick="switchDTab('notes',this)">Notes</button>
        <button class="dtab" onclick="switchDTab('imaging',this)">Imaging</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="exp-btn" style="padding:6px 11px;font-size:.72rem" onclick="printPatient()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:13px;height:13px"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>Print</button>
        <button class="dclose" onclick="closePatDirect()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
      </div>
    </div>
    <div class="dpanel-body" id="dPanelBody"></div>
  </div>
</div>

<!-- ════════ ADD/EDIT PATIENT MODAL ════════ -->
<div class="modal-overlay" id="patModal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Add New Patient</div>
      <button class="dclose" onclick="closeModal()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="editPatId"/>
      <div class="mrow">
        <div class="mf"><label>Full Name *</label><input type="text" id="mName" placeholder="Patient full name"/></div>
        <div class="mf"><label>Date of Birth *</label><input type="date" id="mDob"/></div>
      </div>
      <div class="mrow">
        <div class="mf"><label>Gender</label><select id="mGender"><option value="Male">Male</option><option value="Female">Female</option></select></div>
        <div class="mf"><label>Phone</label><input type="text" id="mPhone" placeholder="+966 5x xxx xxxx"/></div>
      </div>
      <div class="mf"><label>Email</label><input type="email" id="mEmail" placeholder="patient@email.com"/></div>
      <div class="mf"><label>Primary Diagnosis *</label><input type="text" id="mDiag" placeholder="e.g. Knee OA, Lumbar Disc Herniation…"/></div>
      <div class="mrow">
        <div class="mf"><label>Condition Category</label><select id="mCond"><option value="knee">Knee</option><option value="spine">Spine</option><option value="shoulder">Shoulder</option><option value="other">Other</option></select></div>
        <div class="mf"><label>Insurance Provider</label><input type="text" id="mIns" placeholder="BUPA, Tawuniya…"/></div>
      </div>
      <div class="mrow">
        <div class="mf"><label>Insurance No.</label><input type="text" id="mInsNo" placeholder="Policy number"/></div>
        <div class="mf"><label>Imaging Notes</label><input type="text" id="mImaging" placeholder="Brief imaging summary"/></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-save" onclick="savePatient()">Save Patient</button>
    </div>
  </div>
</div>

<!-- ════════ AI ASSISTANT PANEL ════════ -->
<div id="aiPanel">
  <div class="ai-panel-bg" onclick="closeAI()"></div>
  <div class="ai-box">
    <div class="ai-header">
      <div class="ai-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/><circle cx="9" cy="13" r="1" fill="currentColor"/><circle cx="15" cy="13" r="1" fill="currentColor"/></svg></div>
      <div><div class="ai-title">AI Assistant</div><div class="ai-sub">Clinical documentation helper</div></div>
      <button class="ai-close" onclick="closeAI()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div class="ai-modes">
      <button class="ai-mode active" onclick="setAIMode('notes',this)">Draft Notes</button>
      <button class="ai-mode" onclick="setAIMode('summary',this)">Summarize History</button>
    </div>
    <div class="ai-patient-sel">
      <label>Select Patient</label>
      <select id="aiPatSel" onchange="aiPatientChanged()"><option value="">— Choose patient —</option></select>
    </div>
    <div class="ai-quick" id="aiQuick">
      <button class="ai-qbtn" onclick="aiQuick('Draft SOAP note for today\'s visit')">SOAP Note</button>
      <button class="ai-qbtn" onclick="aiQuick('Summarize patient history in 3 sentences')">Quick Summary</button>
      <button class="ai-qbtn" onclick="aiQuick('List current treatment plan and next steps')">Treatment Plan</button>
      <button class="ai-qbtn" onclick="aiQuick('Draft a referral letter summary')">Referral Draft</button>
    </div>
    <div class="ai-chat" id="aiChat">
      <div class="ai-msg ai">Hello, Doctor. Select a patient and I'll help you draft clinical notes or summarize their history. You can also use the quick prompts above.</div>
    </div>
    <div class="ai-input-area">
      <textarea class="ai-input" id="aiInput" placeholder="Type your request…" rows="1" onkeydown="aiKeydown(event)"></textarea>
      <button class="ai-send" onclick="aiSend()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
    </div>
  </div>
</div>

<!-- ════════ PRINT AREA ════════ -->
<div id="printArea"></div>

<!-- Toast -->
<div class="toast" id="toast"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg><span id="toastMsg"></span></div>

<!-- FAB for AI on mobile -->
<button class="fab" onclick="openAI()" title="AI Assistant" id="aiFab">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/><circle cx="9" cy="13" r="1" fill="currentColor"/><circle cx="15" cy="13" r="1" fill="currentColor"/></svg>
</button>

<script>
// ══════════════════════════════════════
//  DATA
// ══════════════════════════════════════
const COLORS = ['c1','c2','c3','c4','c5'];
let PATIENTS = [
  {id:'PT-001',name:'Fatima Al-Hassan',dob:'1978-03-14',age:46,gender:'Female',phone:'+966 50 123 4567',email:'fatima.hassan@email.com',diagnosis:'Osteoarthritis – Right Knee',condition:'knee',insurance:'BUPA Arabia',insuranceNo:'BA-778821',imaging:'AP & Lateral X-ray (Jan 2025) – Grade III OA',color:'c1',
   notes:[{date:'2026-02-18',type:'Follow-up',text:'Patient reports improvement in knee pain. Swelling reduced. Continuing physiotherapy 3x/week. Celecoxib 200mg daily. Review in 4 weeks.'},{date:'2026-01-04',type:'Consultation',text:'Initial assessment. Significant crepitus right knee. Weight-bearing X-ray ordered. Conservative management initiated.'}],
   visits:[{day:'18',mon:'Feb',type:'Follow-up',note:'Knee pain improvement, reduced swelling'},{day:'04',mon:'Jan',type:'Consultation',note:'Initial assessment, X-ray ordered'},{day:'12',mon:'Nov',type:'Consultation',note:'Referred by GP for knee pain'}]},
  {id:'PT-002',name:'Khalid Ibrahim',dob:'1965-07-22',age:59,gender:'Male',phone:'+966 55 987 6543',email:'khalid.ibrahim@email.com',diagnosis:'Lumbar Disc Herniation L4–L5',condition:'spine',insurance:'Tawuniya',insuranceNo:'TW-334455',imaging:'MRI Lumbar Spine (Jan 2025) – L4-L5 disc protrusion',color:'c2',
   notes:[{date:'2026-02-20',type:'Review',text:'MRI confirms L4-L5 herniation with left-sided radiculopathy. SLR positive at 40°. Conservative treatment ongoing: physiotherapy, gabapentin 300mg TID. Surgery not yet indicated.'},{date:'2026-01-10',type:'MRI Review',text:'L4-L5 herniation confirmed. Referred to physiotherapy. NSAIDs prescribed.'}],
   visits:[{day:'20',mon:'Feb',type:'Review',note:'MRI results discussed'},{day:'10',mon:'Jan',type:'MRI Review',note:'L4-L5 herniation confirmed'},{day:'28',mon:'Dec',type:'Consultation',note:'Back pain radiating to left leg'}]},
  {id:'PT-003',name:'Nadia Khoury',dob:'1990-11-05',age:34,gender:'Female',phone:'+966 54 456 7890',email:'nadia.khoury@email.com',diagnosis:'Rotator Cuff Tear – Left Shoulder',condition:'shoulder',insurance:'MedGulf',insuranceNo:'MG-991234',imaging:'MRI Shoulder (Feb 2025) – Partial supraspinatus tear',color:'c3',
   notes:[{date:'2026-02-22',type:'Pre-op',text:'Pre-operative assessment completed. Blood work normal. ECG normal. Patient consented for arthroscopic rotator cuff repair. NPO from midnight. Admitted Feb 27 at 06:00.'}],
   visits:[{day:'22',mon:'Feb',type:'Pre-op',note:'Pre-operative assessment completed'},{day:'15',mon:'Feb',type:'Consultation',note:'MRI confirmed partial tear'},{day:'02',mon:'Feb',type:'Initial Visit',note:'Pain and weakness in left shoulder'}]},
  {id:'PT-004',name:'Ahmed Al-Rashidi',dob:'1972-09-30',age:52,gender:'Male',phone:'+966 56 321 0987',email:'ahmed.rashidi@email.com',diagnosis:'End-stage Knee OA – Right',condition:'knee',insurance:'BUPA Arabia',insuranceNo:'BA-556677',imaging:'Weight-bearing X-ray (Jan 2025) – Bone-on-bone OA',color:'c4',
   notes:[{date:'2026-02-21',type:'Pre-op',text:'TKR scheduled Feb 27. Templating done – size 4 femur, size 3 tibia. Patient on aspirin 75mg held 7 days pre-op. HbA1c 6.4%, acceptable for surgery. Consent signed.'}],
   visits:[{day:'21',mon:'Feb',type:'Pre-op',note:'TKR scheduled Feb 27'},{day:'05',mon:'Feb',type:'Planning',note:'Surgical plan reviewed'},{day:'20',mon:'Jan',type:'Review',note:'Surgery recommended'}]},
  {id:'PT-005',name:'Layla Qasim',dob:'1985-04-18',age:39,gender:'Female',phone:'+966 50 654 3210',email:'layla.qasim@email.com',diagnosis:'Patellofemoral Syndrome',condition:'knee',insurance:'Allianz Saudi',insuranceNo:'AS-112233',imaging:'X-ray (Jan 2025) – Mild patellar tilt',color:'c5',
   notes:[{date:'2026-02-19',type:'Follow-up',text:'Patient responding well to physiotherapy. VMO strengthening exercises commenced. Anterior knee pain reduced from 7/10 to 3/10. Continue current regimen, review in 6 weeks.'}],
   visits:[{day:'19',mon:'Feb',type:'Follow-up',note:'Responding well to physio'},{day:'22',mon:'Jan',type:'Consultation',note:'Anterior knee pain during activity'}]},
  {id:'PT-006',name:'Omar Mansour',dob:'1968-12-01',age:56,gender:'Male',phone:'+966 55 789 0123',email:'omar.mansour@email.com',diagnosis:'Spinal Stenosis L3–L5',condition:'spine',insurance:'Tawuniya',insuranceNo:'TW-667788',imaging:'MRI Lumbar (Feb 2025) – Severe stenosis L3-L5',color:'c1',
   notes:[{date:'2026-02-17',type:'Review',text:'Neurogenic claudication worsening. Walking tolerance now <100m. Bilateral leg weakness. Surgical decompression discussed and agreed. Laminectomy L3-L5 scheduled March 10.'}],
   visits:[{day:'17',mon:'Feb',type:'Review',note:'Neurogenic claudication, surgery planned'},{day:'08',mon:'Jan',type:'Consultation',note:'Bilateral leg weakness'}]},
];

let APPOINTMENTS = [
  {id:'A01',patientId:'PT-001',patient:'Fatima Al-Hassan',reason:'Post-op Follow-up',date:'2026-02-25',time:'09:00',duration:30,status:'confirmed'},
  {id:'A02',patientId:'PT-002',patient:'Khalid Ibrahim',reason:'MRI Result Review',date:'2026-02-25',time:'09:45',duration:45,status:'confirmed'},
  {id:'A03',patientId:'PT-003',patient:'Nadia Khoury',reason:'Pre-operative Assessment',date:'2026-02-25',time:'11:00',duration:60,status:'confirmed'},
  {id:'A04',patientId:'PT-004',patient:'Ahmed Al-Rashidi',reason:'Surgical Consent',date:'2026-02-25',time:'12:30',duration:30,status:'pending'},
  {id:'A05',patientId:'PT-005',patient:'Layla Qasim',reason:'Physiotherapy Review',date:'2026-02-25',time:'14:00',duration:30,status:'confirmed'},
  {id:'A06',patientId:'PT-006',patient:'Omar Mansour',reason:'Spinal Stenosis Consultation',date:'2026-02-25',time:'15:00',duration:45,status:'confirmed'},
  {id:'A07',patientId:'PT-001',patient:'Fatima Al-Hassan',reason:'X-ray Review',date:'2026-02-26',time:'10:00',duration:30,status:'confirmed'},
  {id:'A08',patientId:'PT-002',patient:'Khalid Ibrahim',reason:'Pain Management Review',date:'2026-02-27',time:'09:30',duration:30,status:'pending'},
  {id:'A09',patientId:'PT-005',patient:'Layla Qasim',reason:'Follow-up',date:'2026-02-28',time:'11:00',duration:30,status:'confirmed'},
  {id:'A10',patientId:'PT-006',patient:'Omar Mansour',reason:'Pre-op Review',date:'2026-03-01',time:'08:00',duration:60,status:'confirmed'},
];

let weekOffset = 0, filterCond = 'all', currentPatId = null, aiMode = 'notes';

// ══════════════════════════════════════
//  LOGIN
// ══════════════════════════════════════
document.getElementById('tgpass').addEventListener('click',()=>{
  const p=document.getElementById('password');
  p.type=p.type==='password'?'text':'password';
});
function doLogin(){
  const u=document.getElementById('username').value.trim();
  const p=document.getElementById('password').value;
  const err=document.getElementById('loginError');
  const btn=document.getElementById('loginBtn');
  if(!u||!p){err.classList.add('show');return;}
  btn.classList.add('loading');btn.disabled=true;
  setTimeout(()=>{
    btn.classList.remove('loading');btn.disabled=false;
    if(u==='doctor'&&p==='ortho2024'){
      document.getElementById('loginPage').style.display='none';
      document.getElementById('appShell').classList.add('show');
      initApp();
    }else{err.classList.add('show');document.getElementById('password').value='';}
  },800);
}
document.getElementById('loginBtn').addEventListener('click',doLogin);
['username','password'].forEach(id=>{
  document.getElementById(id).addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
  document.getElementById(id).addEventListener('input',()=>document.getElementById('loginError').classList.remove('show'));
});
document.getElementById('logoutBtn').addEventListener('click',()=>{
  document.getElementById('appShell').classList.remove('show');
  document.getElementById('loginPage').style.display='';
  document.getElementById('username').value='';
  document.getElementById('password').value='';
});

// ══════════════════════════════════════
//  SIDEBAR
// ══════════════════════════════════════
function openSidebar(){
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('sidebarOverlay').classList.add('show');
}
function closeSidebar(){
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('show');
}

// ══════════════════════════════════════
//  NAVIGATION
// ══════════════════════════════════════
const titles={dashboard:'Dashboard',patients:'Patients',appointments:'Appointments'};
function navigate(page){
  document.querySelectorAll('.ni').forEach(n=>n.classList.toggle('active',n.dataset.page===page));
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.getElementById('tbTitle').textContent=titles[page]||page;
  closeSidebar();
  if(page==='appointments')renderWeek();
}
document.querySelectorAll('.ni').forEach(n=>n.addEventListener('click',()=>navigate(n.dataset.page)));

// ══════════════════════════════════════
//  INIT
// ══════════════════════════════════════
function initApp(){
  const now=new Date();
  document.getElementById('tbDate').textContent=now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  renderTodayList();
  renderPGrid();
  renderWeek();
  populateSelects();
  document.getElementById('naDate').value=now.toISOString().split('T')[0];
  updateStats();
}

function updateStats(){
  document.getElementById('statPatients').textContent=PATIENTS.length;
  document.getElementById('patientBadge').textContent=PATIENTS.length;
  document.getElementById('patSubtitle').textContent=PATIENTS.length+' active patients';
  const today='2026-02-25';
  document.getElementById('statToday').textContent=APPOINTMENTS.filter(a=>a.date===today).length;
}

// ══════════════════════════════════════
//  DASHBOARD
// ══════════════════════════════════════
function renderTodayList(){
  const today='2026-02-25';
  const list=document.getElementById('todayList');
  const items=APPOINTMENTS.filter(a=>a.date===today).slice(0,6);
  list.innerHTML=items.map(a=>{
    const ini=a.patient.split(' ').map(w=>w[0]).join('').slice(0,2);
    return`<li class="ai"><div class="at">${a.time}</div><div class="aa">${ini}</div><div class="ain"><div class="an">${a.patient}</div><div class="ar">${a.reason}</div></div><span class="sb s-${a.status}">${cap(a.status)}</span></li>`;
  }).join('');
}

// ══════════════════════════════════════
//  PATIENTS
// ══════════════════════════════════════
let _fp=[...PATIENTS];
function renderPGrid(list=_fp){
  document.getElementById('pGrid').innerHTML=list.map(p=>`
    <div class="pcard" onclick="openPat('${p.id}')">
      <div class="pct">
        <div class="pav ${p.color}">${p.name.split(' ').map(w=>w[0]).join('').slice(0,2)}</div>
        <div><div class="pname">${p.name}</div><div class="pmeta">${p.age} yrs · ${p.gender}</div><div class="pid">${p.id}</div></div>
      </div>
      <div class="pdiag"><div class="pdl">Primary Diagnosis</div>${p.diagnosis}</div>
      <div class="pcf">
        <div class="pvs"><span>${p.visits.length}</span> visits</div>
        <div style="display:flex;gap:6px">
          <button class="pbtn" onclick="event.stopPropagation();openEditPatient('${p.id}')">Edit</button>
          <button class="pbtn" onclick="event.stopPropagation();openPat('${p.id}')">View <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg></button>
        </div>
      </div>
    </div>`).join('');
}
function filterPats(q){
  const base=filterCond==='all'?PATIENTS:PATIENTS.filter(p=>p.condition===filterCond);
  _fp=base.filter(p=>p.name.toLowerCase().includes(q.toLowerCase())||p.diagnosis.toLowerCase().includes(q.toLowerCase())||p.id.includes(q));
  renderPGrid(_fp);
}
function filterBy(c,btn){
  filterCond=c;
  document.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  filterPats(document.getElementById('patSearch').value);
}

// ══════════════════════════════════════
//  PATIENT DETAIL
// ══════════════════════════════════════
function openPat(id){
  currentPatId=id;
  const p=PATIENTS.find(x=>x.id===id);
  if(!p)return;
  renderDTab('info',p);
  document.querySelector('.dtab').click();
  document.getElementById('patOverlay').classList.add('show');
}
function switchDTab(tab,btn){
  document.querySelectorAll('.dtab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  const p=PATIENTS.find(x=>x.id===currentPatId);
  if(p)renderDTab(tab,p);
}
function renderDTab(tab,p){
  document.querySelectorAll('.dp-tab-content').forEach(t=>t.classList.remove('active'));
  const body=document.getElementById('dPanelBody');

  if(tab==='info'){
    body.innerHTML=`<div class="dp-tab-content active">
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px">
        <div class="pav ${p.color}" style="width:50px;height:50px;border-radius:12px;font-size:1.1rem;flex-shrink:0">${p.name.split(' ').map(w=>w[0]).join('').slice(0,2)}</div>
        <div><div style="font-family:'Cormorant Garamond',serif;font-size:1.3rem;font-weight:600;color:var(--navy)">${p.name}</div><div style="font-size:.75rem;color:var(--muted);margin-top:3px">${p.id} · ${p.age} yrs · ${p.gender}</div></div>
      </div>
      <div class="ds"><div class="dst">Personal Information</div>
        <div class="dgr">
          <div class="df"><label>Date of Birth</label><p class="hi">${fmtDate(p.dob)}</p></div>
          <div class="df"><label>Phone</label><p>${p.phone}</p></div>
          <div class="df" style="grid-column:1/-1"><label>Email</label><p>${p.email}</p></div>
        </div>
      </div>
      <div class="ds"><div class="dst">Clinical</div>
        <div class="dgr">
          <div class="df" style="grid-column:1/-1"><label>Primary Diagnosis</label><p class="hi">${p.diagnosis}</p></div>
          <div class="df" style="grid-column:1/-1"><label>Imaging</label><p>${p.imaging}</p></div>
        </div>
      </div>
      <div class="ds"><div class="dst">Insurance</div>
        <div class="dgr">
          <div class="df"><label>Provider</label><p class="hi">${p.insurance}</p></div>
          <div class="df"><label>Policy No.</label><p>${p.insuranceNo}</p></div>
        </div>
      </div>
      <div class="ds"><div class="dst">Visit History</div>
        ${p.visits.map(v=>`<div class="vi"><div class="vdb"><div class="vd">${v.day}</div><div class="vm">${v.mon}</div></div><div><div class="vi-type">${v.type}</div><div class="vi-note">${v.note}</div></div></div>`).join('')}
      </div>
    </div>`;
  }

  if(tab==='notes'){
    const nhtml=p.notes.length?p.notes.map(n=>`
      <div class="note-item">
        <div class="note-item-header"><span class="note-item-date">${n.date}</span><span class="note-item-type">${n.type}</span></div>
        <div class="note-item-text">${n.text}</div>
      </div>`).join(''):'<div style="font-size:.8rem;color:var(--muted);padding:10px 0">No notes yet.</div>';
    body.innerHTML=`<div class="dp-tab-content active">
      <div class="notes-editor">
        ${nhtml}
        <div class="note-new">
          <label>Add New Note</label>
          <select id="noteType"><option>Consultation</option><option>Follow-up</option><option>Pre-op</option><option>Review</option><option>Procedure</option><option>Referral</option></select>
          <textarea id="noteText" placeholder="Enter clinical note…"></textarea>
          <div style="display:flex;gap:8px">
            <button class="bsub2" style="flex:1" onclick="saveNote('${p.id}')">Save Note</button>
            <button class="exp-btn" onclick="openAIForNotes('${p.id}')" style="white-space:nowrap"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width:13px;height:13px"><path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2z"/></svg>AI Help</button>
          </div>
        </div>
      </div>
    </div>`;
  }

  if(tab==='imaging'){
    body.innerHTML=`<div class="dp-tab-content active">
      <div style="margin-bottom:14px">
        <div style="font-size:.78rem;color:var(--muted);margin-bottom:12px">Imaging studies for ${p.name}</div>
        <div class="img-grid">
          <div class="img-item" style="background:linear-gradient(135deg,#0d2f4f,#1a5fa8)">
            <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:8px">
              <svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width:32px;height:32px"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="12" cy="12" r="3"/><path d="M12 3v3M12 18v3M3 12h3M18 12h3"/></svg>
              <span style="font-size:.68rem;color:rgba(255,255,255,0.5)">AP View</span>
            </div>
            <div class="img-item-info"><div class="img-item-label">${p.imaging.split('–')[0].trim()}</div><div class="img-item-date">${p.imaging.match(/\(([^)]+)\)/)?.[1]||'2025'}</div></div>
          </div>
          <div class="img-item" style="background:linear-gradient(135deg,#1a2e42,#2e4a66)">
            <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;gap:8px">
              <svg viewBox="0 0 24 24" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="width:32px;height:32px"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="12" cy="12" r="3"/><path d="M12 3v3M12 18v3M3 12h3M18 12h3"/></svg>
              <span style="font-size:.68rem;color:rgba(255,255,255,0.5)">Lateral View</span>
            </div>
            <div class="img-item-info"><div class="img-item-label">Lateral View</div><div class="img-item-date">${p.imaging.match(/\(([^)]+)\)/)?.[1]||'2025'}</div></div>
          </div>
        </div>
        <div class="ds"><div class="dst">Imaging Report</div>
          <div style="background:var(--ice2);border-radius:9px;padding:12px;font-size:.8rem;color:var(--text);line-height:1.6;border-left:3px solid var(--blue)">${p.imaging}</div>
        </div>
      </div>
      <label style="display:block;font-size:.72rem;font-weight:500;color:var(--navy);margin-bottom:8px">Upload New Image</label>
      <button class="img-upload-btn" onclick="showToast('Image upload — connect to backend in next layer')">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
        Upload X-ray / MRI / CT
      </button>
    </div>`;
  }
}

function saveNote(pid){
  const p=PATIENTS.find(x=>x.id===pid);
  const type=document.getElementById('noteType').value;
  const text=document.getElementById('noteText').value.trim();
  if(!text){showToast('Please enter a note.');return;}
  const today=new Date().toISOString().split('T')[0];
  p.notes.unshift({date:today,type,text});
  p.visits.unshift({day:new Date().getDate().toString().padStart(2,'0'),mon:new Date().toLocaleString('en-US',{month:'short'}),type,note:text.slice(0,50)+'…'});
  renderDTab('notes',p);
  showToast('Note saved for '+p.name);
}

function closePat(e){if(e.target===document.getElementById('patOverlay'))closePatDirect();}
function closePatDirect(){document.getElementById('patOverlay').classList.remove('show');}

// ══════════════════════════════════════
//  ADD / EDIT PATIENT
// ══════════════════════════════════════
function openAddPatient(){
  document.getElementById('modalTitle').textContent='Add New Patient';
  document.getElementById('editPatId').value='';
  ['mName','mDob','mPhone','mEmail','mDiag','mIns','mInsNo','mImaging'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('mGender').value='Male';
  document.getElementById('mCond').value='knee';
  document.getElementById('patModal').classList.add('show');
}
function openEditPatient(id){
  const p=PATIENTS.find(x=>x.id===id);
  if(!p)return;
  document.getElementById('modalTitle').textContent='Edit Patient';
  document.getElementById('editPatId').value=id;
  document.getElementById('mName').value=p.name;
  document.getElementById('mDob').value=p.dob;
  document.getElementById('mGender').value=p.gender;
  document.getElementById('mPhone').value=p.phone;
  document.getElementById('mEmail').value=p.email;
  document.getElementById('mDiag').value=p.diagnosis;
  document.getElementById('mCond').value=p.condition;
  document.getElementById('mIns').value=p.insurance;
  document.getElementById('mInsNo').value=p.insuranceNo;
  document.getElementById('mImaging').value=p.imaging;
  document.getElementById('patModal').classList.add('show');
}
function closeModal(){document.getElementById('patModal').classList.remove('show');}
function savePatient(){
  const editId=document.getElementById('editPatId').value;
  const name=document.getElementById('mName').value.trim();
  const dob=document.getElementById('mDob').value;
  const diag=document.getElementById('mDiag').value.trim();
  if(!name||!dob||!diag){showToast('Please fill required fields (*)');return;}
  const dob_d=new Date(dob);
  const age=Math.floor((new Date()-dob_d)/31557600000);
  if(editId){
    const p=PATIENTS.find(x=>x.id===editId);
    Object.assign(p,{name,dob,age,gender:document.getElementById('mGender').value,phone:document.getElementById('mPhone').value,email:document.getElementById('mEmail').value,diagnosis:diag,condition:document.getElementById('mCond').value,insurance:document.getElementById('mIns').value,insuranceNo:document.getElementById('mInsNo').value,imaging:document.getElementById('mImaging').value||p.imaging});
    showToast('Patient record updated');
  }else{
    const id='PT-'+String(PATIENTS.length+1).padStart(3,'0');
    PATIENTS.push({id,name,dob,age,gender:document.getElementById('mGender').value,phone:document.getElementById('mPhone').value,email:document.getElementById('mEmail').value,diagnosis:diag,condition:document.getElementById('mCond').value,insurance:document.getElementById('mIns').value,insuranceNo:document.getElementById('mInsNo').value,imaging:document.getElementById('mImaging').value||'Pending',color:COLORS[PATIENTS.length%5],notes:[],visits:[]});
    showToast('New patient '+name+' added');
  }
  closeModal();
  filterPats(document.getElementById('patSearch').value);
  populateSelects();
  updateStats();
}

// ══════════════════════════════════════
//  APPOINTMENTS
// ══════════════════════════════════════
const DOWS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
const MONS=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
function getWeekDates(off){
  const base=new Date('2026-02-23');
  base.setDate(base.getDate()+off*7);
  return Array.from({length:5},(_,i)=>{const d=new Date(base);d.setDate(d.getDate()+i);return d;});
}
function changeWeek(d){weekOffset+=d;renderWeek();}
function renderWeek(){
  const days=getWeekDates(weekOffset);
  const today='2026-02-25';
  document.getElementById('weekLabel').textContent=`${days[0].getDate()} ${MONS[days[0].getMonth()]} – ${days[4].getDate()} ${MONS[days[4].getMonth()]} ${days[0].getFullYear()}`;
  document.getElementById('apptSub').textContent=`Week of ${days[0].getDate()} ${MONS[days[0].getMonth()]}`;
  // Responsive: show 3 days on small screens
  const cols=document.getElementById('weekCols');
  const mobile=window.innerWidth<768;
  const showDays=mobile?days.slice(0,3):days;
  cols.style.gridTemplateColumns=`repeat(${showDays.length},1fr)`;
  cols.innerHTML=showDays.map(d=>{
    const ds=d.toISOString().split('T')[0];
    const isToday=ds===today;
    const da=APPOINTMENTS.filter(a=>a.date===ds).sort((a,b)=>a.time.localeCompare(b.time));
    return`<div class="day-col">
      <div class="dch${isToday?' today':''}"><div class="dow">${DOWS[d.getDay()]}</div><div class="dd">${d.getDate()}</div></div>
      ${da.map(a=>`<div class="ablk ${a.status}"><div class="abt">${a.time}</div><div class="abn">${a.patient.split(' ')[0]} ${a.patient.split(' ').slice(-1)[0]}</div><div class="abr">${a.reason}</div><div class="abd">${a.duration}m · ${cap(a.status)}</div></div>`).join('')}
      ${da.length===0?'<div style="text-align:center;font-size:.7rem;color:var(--muted2);padding:12px 0">—</div>':''}
    </div>`;
  }).join('');
}
function addAppt(){
  const pid=document.getElementById('naPat').value;
  const reason=document.getElementById('naReason').value.trim();
  const date=document.getElementById('naDate').value;
  const time=document.getElementById('naTime').value;
  if(!pid||!reason||!date||!time){showToast('Please fill all fields');return;}
  const pat=PATIENTS.find(p=>p.id===pid);
  APPOINTMENTS.push({id:'A'+String(APPOINTMENTS.length+1).padStart(2,'0'),patientId:pid,patient:pat.name,reason,date,time,duration:parseInt(document.getElementById('naDur').value),status:document.getElementById('naStatus').value});
  renderWeek();renderTodayList();updateStats();
  document.getElementById('naPat').value='';
  document.getElementById('naReason').value='';
  document.getElementById('naTime').value='';
  showToast('Appointment scheduled for '+pat.name);
}
function populateSelects(){
  ['naPat','aiPatSel'].forEach(selId=>{
    const sel=document.getElementById(selId);
    const cur=sel.value;
    const first=sel.options[0];
    sel.innerHTML='';
    sel.appendChild(first);
    PATIENTS.forEach(p=>{const o=document.createElement('option');o.value=p.id;o.textContent=p.name;sel.appendChild(o);});
    sel.value=cur;
  });
}

// ══════════════════════════════════════
//  AI ASSISTANT
// ══════════════════════════════════════
function openAI(){document.getElementById('aiPanel').classList.add('show');}
function closeAI(){document.getElementById('aiPanel').classList.remove('show');}
function setAIMode(m,btn){
  aiMode=m;
  document.querySelectorAll('.ai-mode').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}
function aiPatientChanged(){
  const pid=document.getElementById('aiPatSel').value;
  if(pid){
    const p=PATIENTS.find(x=>x.id===pid);
    addAIMsg('ai',`Patient selected: <strong>${p.name}</strong> (${p.age} yrs, ${p.gender})<br>Diagnosis: ${p.diagnosis}<br>Ready to help with ${aiMode==='notes'?'drafting clinical notes':'summarizing history'}. What would you like?`);
  }
}
function openAIForNotes(pid){
  document.getElementById('aiPatSel').value=pid;
  aiPatientChanged();
  openAI();
}
function aiQuick(prompt){
  document.getElementById('aiInput').value=prompt;
  aiSend();
}
function aiKeydown(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();aiSend();}}
function addAIMsg(role,html){
  const chat=document.getElementById('aiChat');
  const div=document.createElement('div');
  div.className='ai-msg '+role;
  div.innerHTML=html;
  chat.appendChild(div);
  chat.scrollTop=chat.scrollHeight;
  return div;
}
function aiSend(){
  const inp=document.getElementById('aiInput');
  const msg=inp.value.trim();
  if(!msg)return;
  const pid=document.getElementById('aiPatSel').value;
  addAIMsg('user',msg);
  inp.value='';
  const thinking=addAIMsg('ai','<span class="pulse">Thinking…</span>');
  setTimeout(()=>{
    thinking.remove();
    const pat=pid?PATIENTS.find(x=>x.id===pid):null;
    const resp=generateAIResponse(msg,pat,aiMode);
    addAIMsg('ai',resp);
  },1200+Math.random()*800);
}
function generateAIResponse(msg,pat,mode){
  const ml=msg.toLowerCase();
  if(!pat){
    if(ml.includes('soap'))return`<strong>SOAP Note Template:</strong><br><br><strong>S (Subjective):</strong> Patient reports [chief complaint]. Pain score [x]/10. Duration: [x weeks/months].<br><br><strong>O (Objective):</strong> ROM [x]°. [Positive/Negative] special tests. Vital signs stable.<br><br><strong>A (Assessment):</strong> [Diagnosis]. [Stable/Improving/Worsening].<br><br><strong>P (Plan):</strong> [Treatment]. Review in [x] weeks.<br><br><em>Select a patient for a personalized note.</em>`;
    return`Please select a patient first so I can provide context-specific assistance.`;
  }
  const lastNote=pat.notes[0];
  if(mode==='summary'||ml.includes('summar')||ml.includes('history')){
    return`<strong>Patient Summary — ${pat.name}</strong><br><br>${pat.name} is a ${pat.age}-year-old ${pat.gender.toLowerCase()} presenting with <strong>${pat.diagnosis}</strong>. The patient has had ${pat.visits.length} recorded visits. ${lastNote?`Most recent assessment (${lastNote.date}): ${lastNote.text.slice(0,120)}…`:'No notes recorded yet.'}<br><br>Imaging: ${pat.imaging}.<br><br><em>Insurance: ${pat.insurance} (${pat.insuranceNo})</em>`;
  }
  if(ml.includes('soap')){
    return`<strong>SOAP Note — ${pat.name}</strong><br><br><strong>S:</strong> ${pat.age}-year-old ${pat.gender.toLowerCase()} with ${pat.diagnosis}. ${lastNote?lastNote.text.slice(0,80)+'…':'Presents for follow-up.'}<br><br><strong>O:</strong> Patient appears comfortable. Relevant clinical findings per examination. Vital signs stable.<br><br><strong>A:</strong> ${pat.diagnosis} — ${lastNote?'ongoing management':'initial assessment'}.<br><br><strong>P:</strong> Continue current treatment plan. Follow-up in 4 weeks. Review imaging ${pat.imaging.includes('MRI')?'MRI':'X-ray'} findings.`;
  }
  if(ml.includes('treatment')||ml.includes('plan')){
    return`<strong>Treatment Plan — ${pat.name}</strong><br><br>Current diagnosis: <strong>${pat.diagnosis}</strong><br><br>Recommended approach:<br>• Conservative management first line<br>• Physiotherapy and rehabilitation<br>• Analgesia as required<br>• Serial clinical review<br>• Imaging follow-up as indicated<br><br>${pat.condition==='knee'?'Consider surgical options if conservative fails at 3 months.':pat.condition==='spine'?'Neurosurgical referral if neurological deficit progresses.':'Surgical reconstruction if conservative fails.'}`;
  }
  if(ml.includes('referral')){
    return`<strong>Referral Summary — ${pat.name}</strong><br><br>Dear Colleague,<br><br>I am referring this ${pat.age}-year-old ${pat.gender.toLowerCase()} patient with a diagnosis of <strong>${pat.diagnosis}</strong> for your expert opinion and management.<br><br>Relevant investigations: ${pat.imaging}.<br><br>The patient has undergone ${pat.visits.length} consultations to date. ${lastNote?`Recent clinical note: "${lastNote.text.slice(0,100)}…"`:'Please see attached records.'}<br><br>Thank you for your kind assistance.`;
  }
  return`For <strong>${pat.name}</strong> (${pat.diagnosis}):<br><br>${lastNote?`Last note (${lastNote.date}): "${lastNote.text.slice(0,150)}…"`:'No previous notes on file.'}<br><br>I can help you draft a SOAP note, treatment plan, referral letter, or patient history summary. What would you like?`;
}

// ══════════════════════════════════════
//  PRINT
// ══════════════════════════════════════
function printPatient(){
  const p=PATIENTS.find(x=>x.id===currentPatId);
  if(!p)return;
  const pa=document.getElementById('printArea');
  pa.innerHTML=`
    <h1>${p.name}</h1>
    <div class="pr-meta">${p.id} · ${p.age} years · ${p.gender} · Printed ${new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}</div>
    <div class="pr-sec"><h2>Personal Information</h2>
      <div class="pr-grid">
        <div class="pr-field"><label>Date of Birth</label><p>${fmtDate(p.dob)}</p></div>
        <div class="pr-field"><label>Phone</label><p>${p.phone}</p></div>
        <div class="pr-field"><label>Email</label><p>${p.email}</p></div>
      </div>
    </div>
    <div class="pr-sec"><h2>Clinical</h2>
      <div class="pr-field"><label>Primary Diagnosis</label><p>${p.diagnosis}</p></div>
      <div class="pr-field" style="margin-top:8px"><label>Imaging</label><p>${p.imaging}</p></div>
    </div>
    <div class="pr-sec"><h2>Insurance</h2>
      <div class="pr-grid">
        <div class="pr-field"><label>Provider</label><p>${p.insurance}</p></div>
        <div class="pr-field"><label>Policy No.</label><p>${p.insuranceNo}</p></div>
      </div>
    </div>
    <div class="pr-sec"><h2>Clinical Notes</h2>
      ${p.notes.map(n=>`<div style="margin-bottom:12px;padding:10px;background:#f4f9ff;border-radius:6px"><strong>${n.date} — ${n.type}</strong><br>${n.text}</div>`).join('')||'<p>No notes recorded.</p>'}
    </div>
    <div class="pr-sec"><h2>Visit History</h2>
      ${p.visits.map(v=>`<p style="margin-bottom:6px"><strong>${v.day} ${v.mon}:</strong> ${v.type} — ${v.note}</p>`).join('')}
    </div>`;
  window.print();
}

// ══════════════════════════════════════
//  EXPORT CSV
// ══════════════════════════════════════
function exportPatientCSV(){
  const rows=[['ID','Name','DOB','Age','Gender','Phone','Email','Diagnosis','Insurance','Policy No']];
  PATIENTS.forEach(p=>rows.push([p.id,p.name,p.dob,p.age,p.gender,p.phone,p.email,p.diagnosis,p.insurance,p.insuranceNo]));
  downloadCSV(rows,'patients_export.csv');
  showToast('Patients list exported');
}
function exportApptCSV(){
  const rows=[['ID','Patient','Reason','Date','Time','Duration (min)','Status']];
  APPOINTMENTS.forEach(a=>rows.push([a.id,a.patient,a.reason,a.date,a.time,a.duration,a.status]));
  downloadCSV(rows,'appointments_export.csv');
  showToast('Appointments exported');
}
function downloadCSV(rows,filename){
  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;a.download=filename;a.click();
  URL.revokeObjectURL(url);
}

// ══════════════════════════════════════
//  HELPERS
// ══════════════════════════════════════
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1)}
function fmtDate(s){return new Date(s).toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'})}
function showToast(msg){
  const t=document.getElementById('toast');
  document.getElementById('toastMsg').textContent=msg;
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3000);
}

// Global search
document.getElementById('gSearch').addEventListener('input',function(){
  if(this.value.trim()){navigate('patients');document.getElementById('patSearch').value=this.value;filterPats(this.value);}
});

// Responsive week re-render on resize
window.addEventListener('resize',()=>{if(document.getElementById('page-appointments').classList.contains('active'))renderWeek();});
</script>
</body>
</html>

