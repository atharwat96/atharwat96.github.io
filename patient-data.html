<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --navy: #0a1628;
    --navy-mid: #112240;
    --navy-light: #1a3461;
    --accent: #2563eb;
    --accent-light: #3b82f6;
    --accent-glow: rgba(37,99,235,0.25);
    --white: #ffffff;
    --off-white: #f0f4ff;
    --border: rgba(255,255,255,0.1);
    --text-muted: rgba(255,255,255,0.55);
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --row-hover: rgba(37,99,235,0.08);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Cairo', sans-serif;
    background: var(--navy);
    color: var(--white);
    min-height: 100vh;
    direction: rtl;
  }

  /* Background texture */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 80% 50% at 20% 20%, rgba(37,99,235,0.12) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 80%, rgba(17,34,64,0.8) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 24px 40px;
  }

  /* Header */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 28px 0 24px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 28px;
    flex-wrap: wrap;
    gap: 16px;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .logo-icon {
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, var(--accent), #1d4ed8);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    box-shadow: 0 0 20px var(--accent-glow);
  }

  h1 {
    font-size: 1.6rem;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  h1 span {
    display: block;
    font-size: 0.78rem;
    font-weight: 400;
    color: var(--text-muted);
    letter-spacing: 0.05em;
    margin-top: 2px;
  }

  .header-actions {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    border-radius: 10px;
    font-family: 'Cairo', sans-serif;
    font-size: 0.88rem;
    font-weight: 600;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--accent), #1d4ed8);
    color: white;
    box-shadow: 0 4px 15px var(--accent-glow);
  }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(37,99,235,0.4); }

  .btn-success {
    background: rgba(16,185,129,0.15);
    color: var(--success);
    border: 1px solid rgba(16,185,129,0.3);
  }
  .btn-success:hover { background: rgba(16,185,129,0.25); }

  .btn-danger {
    background: rgba(239,68,68,0.15);
    color: var(--danger);
    border: 1px solid rgba(239,68,68,0.3);
  }
  .btn-danger:hover { background: rgba(239,68,68,0.25); }

  .btn-ghost {
    background: rgba(255,255,255,0.06);
    color: var(--white);
    border: 1px solid var(--border);
  }
  .btn-ghost:hover { background: rgba(255,255,255,0.1); }

  .btn-sm {
    padding: 6px 12px;
    font-size: 0.8rem;
    border-radius: 7px;
  }

  /* Stats bar */
  .stats-bar {
    display: flex;
    gap: 16px;
    margin-bottom: 24px;
    flex-wrap: wrap;
  }

  .stat-card {
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 14px 22px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
    min-width: 140px;
  }

  .stat-icon {
    font-size: 1.5rem;
    opacity: 0.85;
  }

  .stat-info label {
    display: block;
    font-size: 0.72rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .stat-info strong {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--accent-light);
  }

  /* Search & Filter */
  .toolbar {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
    align-items: center;
    flex-wrap: wrap;
  }

  .search-wrapper {
    position: relative;
    flex: 1;
    min-width: 200px;
  }

  .search-wrapper input {
    width: 100%;
    padding: 10px 16px 10px 42px;
    background: rgba(255,255,255,0.06);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--white);
    font-family: 'Cairo', sans-serif;
    font-size: 0.9rem;
    transition: border-color 0.2s;
  }

  .search-wrapper input:focus { outline: none; border-color: var(--accent); }
  .search-wrapper input::placeholder { color: var(--text-muted); }

  .search-icon {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    font-size: 1rem;
  }

  /* Sync status */
  .sync-status {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 10px;
    font-size: 0.82rem;
    color: var(--text-muted);
  }

  .sync-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--success);
    box-shadow: 0 0 8px var(--success);
    animation: pulse 2s infinite;
  }

  .sync-dot.syncing {
    background: var(--warning);
    box-shadow: 0 0 8px var(--warning);
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  /* Table */
  .table-wrapper {
    overflow-x: auto;
    border-radius: 16px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,0.02);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1400px;
    direction: rtl;
  }

  thead {
    background: rgba(37,99,235,0.12);
    border-bottom: 1px solid rgba(37,99,235,0.3);
  }

  th {
    padding: 14px 14px;
    font-size: 0.78rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--accent-light);
    text-align: right;
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
    transition: color 0.2s;
  }

  th:hover { color: var(--white); }

  th.actions-col { text-align: center; min-width: 100px; }

  tbody tr {
    border-bottom: 1px solid rgba(255,255,255,0.04);
    transition: background 0.15s;
  }

  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: var(--row-hover); }

  td {
    padding: 13px 14px;
    font-size: 0.87rem;
    color: rgba(255,255,255,0.87);
    text-align: right;
    white-space: nowrap;
  }

  td.actions-col {
    text-align: center;
    display: flex;
    gap: 6px;
    justify-content: center;
  }

  .name-cell { font-weight: 600; color: var(--white); }

  .badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .badge-green { background: rgba(16,185,129,0.15); color: var(--success); }
  .badge-red { background: rgba(239,68,68,0.15); color: var(--danger); }
  .badge-yellow { background: rgba(245,158,11,0.15); color: var(--warning); }
  .badge-blue { background: rgba(37,99,235,0.15); color: var(--accent-light); }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(6px);
    z-index: 100;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }

  .modal-overlay.active { display: flex; }

  .modal {
    background: var(--navy-mid);
    border: 1px solid rgba(37,99,235,0.3);
    border-radius: 20px;
    padding: 32px;
    width: 100%;
    max-width: 780px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    animation: modalIn 0.25s ease;
    direction: rtl;
  }

  @keyframes modalIn {
    from { opacity: 0; transform: translateY(20px) scale(0.97); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 28px;
  }

  .modal-title { font-size: 1.2rem; font-weight: 700; }
  .modal-close {
    width: 36px;
    height: 36px;
    background: rgba(255,255,255,0.08);
    border: none;
    border-radius: 8px;
    color: var(--white);
    font-size: 1.1rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  .modal-close:hover { background: rgba(239,68,68,0.25); color: var(--danger); }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .form-group.full-width { grid-column: 1 / -1; }
  .form-group.two-col { grid-column: span 2; }

  label {
    font-size: 0.78rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.06em;
  }

  input[type="text"], input[type="number"], textarea, select {
    padding: 10px 14px;
    background: rgba(255,255,255,0.06);
    border: 1px solid var(--border);
    border-radius: 9px;
    color: var(--white);
    font-family: 'Cairo', sans-serif;
    font-size: 0.9rem;
    transition: border-color 0.2s, background 0.2s;
    direction: rtl;
  }

  input[type="text"]:focus,
  input[type="number"]:focus,
  textarea:focus,
  select:focus {
    outline: none;
    border-color: var(--accent);
    background: rgba(37,99,235,0.08);
  }

  input::placeholder, textarea::placeholder { color: var(--text-muted); }

  select option { background: var(--navy-mid); color: var(--white); }

  textarea { resize: vertical; min-height: 80px; }

  .modal-footer {
    display: flex;
    justify-content: flex-start;
    gap: 12px;
    padding-top: 20px;
    border-top: 1px solid var(--border);
  }

  /* Sheets Config Modal */
  .config-section {
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .config-section h3 {
    font-size: 0.92rem;
    font-weight: 700;
    margin-bottom: 14px;
    color: var(--accent-light);
  }

  .code-snippet {
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 16px;
    font-family: monospace;
    font-size: 0.78rem;
    color: #a5f3fc;
    overflow-x: auto;
    white-space: pre;
    direction: ltr;
    text-align: left;
    margin-top: 10px;
  }

  .steps { padding-right: 20px; }
  .steps li {
    margin-bottom: 8px;
    font-size: 0.87rem;
    color: rgba(255,255,255,0.8);
    line-height: 1.6;
  }

  /* Toast */
  .toast-container {
    position: fixed;
    top: 24px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    display: flex;
    flex-direction: column;
    gap: 10px;
    pointer-events: none;
  }

  .toast {
    background: var(--navy-mid);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 20px;
    font-size: 0.87rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.4);
    animation: toastIn 0.3s ease;
    min-width: 260px;
    text-align: center;
    justify-content: center;
  }

  @keyframes toastIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .toast.success { border-color: rgba(16,185,129,0.4); color: var(--success); }
  .toast.error { border-color: rgba(239,68,68,0.4); color: var(--danger); }
  .toast.info { border-color: rgba(37,99,235,0.4); color: var(--accent-light); }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }
  .empty-state .icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }
  .empty-state p { font-size: 0.9rem; }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }

  /* Responsive */
  @media (max-width: 768px) {
    .form-grid { grid-template-columns: 1fr 1fr; }
    h1 { font-size: 1.2rem; }
    .stats-bar { gap: 10px; }
  }

  @media (max-width: 500px) {
    .form-grid { grid-template-columns: 1fr; }
    .form-group.two-col { grid-column: span 1; }
  }
</style>
</head>
<body>

<div class="toast-container" id="toastContainer"></div>

<div class="container">
  <header>
    <div class="header-left">
      <div class="logo-icon">ğŸ¥</div>
      <h1>
        Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰
        <span>Patient Data Management System</span>
      </h1>
    </div>
    <div class="header-actions">
      <div class="sync-status" id="syncStatus">
        <div class="sync-dot" id="syncDot"></div>
        <span id="syncText">ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ù€ Google Sheets</span>
      </div>
      <button class="btn btn-ghost" onclick="openConfigModal()">âš™ï¸ Google Sheets</button>
      <button class="btn btn-success" onclick="syncFromSheets()">ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø©</button>
      <button class="btn btn-primary" onclick="openAddModal()">+ Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶</button>
    </div>
  </header>

  <div class="stats-bar">
    <div class="stat-card">
      <div class="stat-icon">ğŸ‘¥</div>
      <div class="stat-info">
        <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø¶Ù‰</label>
        <strong id="statTotal">0</strong>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">âœ…</div>
      <div class="stat-info">
        <label>ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„</label>
        <strong id="statAdmitted" style="color:#10b981">0</strong>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">â³</div>
      <div class="stat-info">
        <label>ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</label>
        <strong id="statPending" style="color:#f59e0b">0</strong>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">ğŸ”„</div>
      <div class="stat-info">
        <label>Ø¢Ø®Ø± Ù…Ø²Ø§Ù…Ù†Ø©</label>
        <strong id="statSync" style="font-size:0.9rem;color:rgba(255,255,255,0.6)">â€”</strong>
      </div>
    </div>
  </div>

  <div class="toolbar">
    <div class="search-wrapper">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ØªØ´Ø®ÙŠØµ..." oninput="renderTable()">
    </div>
    <select style="min-width:150px" id="filterDecision" onchange="renderTable()">
      <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª</option>
      <option value="Ù‚Ø¨ÙˆÙ„">Ù‚Ø¨ÙˆÙ„</option>
      <option value="Ø§Ù†ØªØ¸Ø§Ø±">Ø§Ù†ØªØ¸Ø§Ø±</option>
      <option value="Ø±ÙØ¶">Ø±ÙØ¶</option>
      <option value="ØªØ­ÙˆÙŠÙ„">ØªØ­ÙˆÙŠÙ„</option>
    </select>
  </div>

  <div class="table-wrapper">
    <table id="patientTable">
      <thead>
        <tr>
          <th onclick="sortBy('name')">Ø§Ù„Ø§Ø³Ù… â–¾</th>
          <th onclick="sortBy('age')">Ø§Ù„Ø¹Ù…Ø±</th>
          <th onclick="sortBy('diagnosis')">Ø§Ù„ØªØ´Ø®ÙŠØµ</th>
          <th onclick="sortBy('decision')">Ø§Ù„Ù‚Ø±Ø§Ø±</th>
          <th>Hb</th>
          <th>PLT</th>
          <th>INR</th>
          <th>LFT</th>
          <th>RFT</th>
          <th>ABO</th>
          <th>VIR</th>
          <th>Anastasia</th>
          <th>Skin</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          <th class="actions-col">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div class="empty-state" id="emptyState" style="display:none;">
      <div class="icon">ğŸ¥</div>
      <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±Ø¶Ù‰. Ø£Ø¶Ù Ø£ÙˆÙ„ Ù…Ø±ÙŠØ¶ Ø£Ùˆ Ù‚Ù… Ø¨Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Google Sheets.</p>
    </div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div class="modal-overlay" id="patientModal">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitle">Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯</h2>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="form-grid">
      <div class="form-group two-col">
        <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *</label>
        <input type="text" id="f_name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶">
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ø¹Ù…Ø±</label>
        <input type="number" id="f_age" placeholder="Ø³Ù†Ø©" min="0" max="150">
      </div>
      <div class="form-group two-col">
        <label>Ø§Ù„ØªØ´Ø®ÙŠØµ</label>
        <input type="text" id="f_diagnosis" placeholder="Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø·Ø¨ÙŠ">
      </div>
      <div class="form-group">
        <label>Ø§Ù„Ù‚Ø±Ø§Ø±</label>
        <select id="f_decision">
          <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø±Ø§Ø±</option>
          <option value="Ù‚Ø¨ÙˆÙ„">Ù‚Ø¨ÙˆÙ„</option>
          <option value="Ø§Ù†ØªØ¸Ø§Ø±">Ø§Ù†ØªØ¸Ø§Ø±</option>
          <option value="Ø±ÙØ¶">Ø±ÙØ¶</option>
          <option value="ØªØ­ÙˆÙŠÙ„">ØªØ­ÙˆÙŠÙ„</option>
        </select>
      </div>
      <div class="form-group">
        <label>Hb (g/dL)</label>
        <input type="text" id="f_hb" placeholder="e.g. 12.5">
      </div>
      <div class="form-group">
        <label>PLT (Ã—10Â³/Î¼L)</label>
        <input type="text" id="f_plt" placeholder="e.g. 250">
      </div>
      <div class="form-group">
        <label>INR</label>
        <input type="text" id="f_inr" placeholder="e.g. 1.1">
      </div>
      <div class="form-group">
        <label>LFT</label>
        <input type="text" id="f_lft" placeholder="Ø·Ø¨ÙŠØ¹ÙŠ / ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠ">
      </div>
      <div class="form-group">
        <label>RFT</label>
        <input type="text" id="f_rft" placeholder="Ø·Ø¨ÙŠØ¹ÙŠ / ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠ">
      </div>
      <div class="form-group">
        <label>ABO (Blood Group)</label>
        <select id="f_abo">
          <option value="">Ø§Ø®ØªØ± ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…</option>
          <option>A+</option><option>A-</option>
          <option>B+</option><option>B-</option>
          <option>AB+</option><option>AB-</option>
          <option>O+</option><option>O-</option>
        </select>
      </div>
      <div class="form-group">
        <label>VIR (Viral Screen)</label>
        <input type="text" id="f_vir" placeholder="Ø³Ù„Ø¨ÙŠ / Ø¥ÙŠØ¬Ø§Ø¨ÙŠ">
      </div>
      <div class="form-group">
        <label>Anastasia</label>
        <input type="text" id="f_anastasia" placeholder="Ù…ÙˆØ§ÙÙ‚ / Ø±ÙØ¶">
      </div>
      <div class="form-group">
        <label>Skin</label>
        <input type="text" id="f_skin" placeholder="Ø·Ø¨ÙŠØ¹ÙŠ / Ù…Ù„Ø§Ø­Ø¸Ø§Øª">
      </div>
      <div class="form-group full-width">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
        <textarea id="f_notes" placeholder="Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-primary" onclick="savePatient()">ğŸ’¾ Ø­ÙØ¸</button>
      <button class="btn btn-ghost" onclick="closeModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- Config Modal -->
<div class="modal-overlay" id="configModal">
  <div class="modal" style="max-width:700px">
    <div class="modal-header">
      <h2 class="modal-title">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Google Sheets</h2>
      <button class="modal-close" onclick="closeConfigModal()">âœ•</button>
    </div>

    <div class="config-section">
      <h3>ğŸ“‹ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ø±Ø¨Ø· Ù…Ø¹ Google Sheets</h3>
      <ol class="steps">
        <li>Ø£Ù†Ø´Ø¦ Ø¬Ø¯ÙˆÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Google Sheets Ø¬Ø¯ÙŠØ¯ ÙˆØ£Ø¶Ù Ø£Ø¹Ù…Ø¯Ø©: <strong>Name, Age, Diagnosis, Decision, Hb, Plt, INR, LFT, RFT, ABO, VIR, Anastasia, Skin, Notes</strong> ÙÙŠ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„.</li>
        <li>Ø§ÙØªØ­ <strong>Extensions â†’ Apps Script</strong> ÙˆØ§Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ§Ù„ÙŠ:</li>
      </ol>
      <div class="code-snippet">const SHEET_NAME = "Sheet1";

function doGet(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  const headers = data[0];
  const rows = data.slice(1).map((row, i) => {
    const obj = {id: i+1};
    headers.forEach((h,j) => obj[h] = row[j]);
    return obj;
  });
  return ContentService.createTextOutput(JSON.stringify({data: rows}))
    .setMimeType(ContentService.MimeType.JSON);
}

function doPost(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_NAME);
  const payload = JSON.parse(e.postData.contents);
  const {action, row, id} = payload;
  const headers = sheet.getRange(1,1,1,sheet.getLastColumn()).getValues()[0];

  if (action === "add") {
    const newRow = headers.map(h => row[h] || "");
    sheet.appendRow(newRow);
  } else if (action === "update") {
    const allData = sheet.getDataRange().getValues();
    sheet.getRange(id+1, 1, 1, headers.length).setValues([headers.map(h => row[h] || "")]);
  } else if (action === "delete") {
    sheet.deleteRow(id+1);
  }
  return ContentService.createTextOutput(JSON.stringify({success: true}))
    .setMimeType(ContentService.MimeType.JSON);
}</div>
      <ol class="steps" start="3">
        <li>Ø§Ù†Ù‚Ø± <strong>Deploy â†’ New Deployment â†’ Web App</strong> ÙˆØ§Ø®ØªØ± "Anyone" Ù„Ù„ÙˆØµÙˆÙ„.</li>
        <li>Ø§Ù†Ø³Ø® URL Ø§Ù„Ù†Ø´Ø± ÙˆØ¶Ø¹Ù‡ Ø£Ø¯Ù†Ø§Ù‡:</li>
      </ol>
    </div>

    <div class="form-group" style="margin-bottom:20px">
      <label>Google Apps Script Web App URL</label>
      <input type="text" id="sheetsUrl" placeholder="https://script.google.com/macros/s/...">
    </div>

    <div class="modal-footer">
      <button class="btn btn-primary" onclick="saveConfig()">âœ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      <button class="btn btn-success" onclick="testConnection()">ğŸ”Œ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„</button>
      <button class="btn btn-ghost" onclick="closeConfigModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<script>
  // â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let patients = JSON.parse(localStorage.getItem('patients') || '[]');
  let sheetsUrl = localStorage.getItem('sheetsUrl') || '';
  let editingId = null;
  let sortKey = 'name';
  let sortAsc = true;
  let nextId = parseInt(localStorage.getItem('nextId') || '1');

  // Load URL into config on startup
  document.getElementById('sheetsUrl').value = sheetsUrl;
  if (sheetsUrl) updateSyncStatus(true);

  // â”€â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function renderTable() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const filterDecision = document.getElementById('filterDecision').value;

    let filtered = patients.filter(p => {
      const matchSearch = !search || (p.name||'').toLowerCase().includes(search) || (p.diagnosis||'').toLowerCase().includes(search);
      const matchDecision = !filterDecision || p.decision === filterDecision;
      return matchSearch && matchDecision;
    });

    filtered.sort((a,b) => {
      let va = a[sortKey] || '', vb = b[sortKey] || '';
      if (!isNaN(va) && !isNaN(vb)) { va = parseFloat(va); vb = parseFloat(vb); }
      if (va < vb) return sortAsc ? -1 : 1;
      if (va > vb) return sortAsc ? 1 : -1;
      return 0;
    });

    const tbody = document.getElementById('tableBody');
    const empty = document.getElementById('emptyState');

    if (filtered.length === 0) {
      tbody.innerHTML = '';
      empty.style.display = 'block';
      tbody.parentElement.querySelector('thead').style.display = 'none';
    } else {
      empty.style.display = 'none';
      tbody.parentElement.querySelector('thead').style.display = '';
      tbody.innerHTML = filtered.map(p => `
        <tr>
          <td class="name-cell">${esc(p.name)}</td>
          <td>${esc(p.age)}</td>
          <td>${esc(p.diagnosis)}</td>
          <td>${decisionBadge(p.decision)}</td>
          <td>${hbBadge(p.hb)}</td>
          <td>${esc(p.plt)}</td>
          <td>${inrBadge(p.inr)}</td>
          <td>${labBadge(p.lft)}</td>
          <td>${labBadge(p.rft)}</td>
          <td><span class="badge badge-blue">${esc(p.abo)}</span></td>
          <td>${virBadge(p.vir)}</td>
          <td>${esc(p.anastasia)}</td>
          <td>${esc(p.skin)}</td>
          <td style="max-width:180px;white-space:normal;font-size:0.8rem;color:var(--text-muted)">${esc(p.notes)}</td>
          <td class="actions-col">
            <button class="btn btn-ghost btn-sm" onclick="openEditModal(${p.id})" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
            <button class="btn btn-danger btn-sm" onclick="deletePatient(${p.id})" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `).join('');
    }

    updateStats();
  }

  function esc(v) { return (v===undefined||v===null||v==='') ? '<span style="color:var(--text-muted)">â€”</span>' : String(v).replace(/</g,'&lt;'); }

  function decisionBadge(v) {
    if (!v) return esc('');
    const map = { 'Ù‚Ø¨ÙˆÙ„':'badge-green', 'Ø§Ù†ØªØ¸Ø§Ø±':'badge-yellow', 'Ø±ÙØ¶':'badge-red', 'ØªØ­ÙˆÙŠÙ„':'badge-blue' };
    return `<span class="badge ${map[v]||'badge-blue'}">${esc(v)}</span>`;
  }

  function hbBadge(v) {
    if (!v) return esc('');
    const n = parseFloat(v);
    const cls = isNaN(n) ? 'badge-blue' : (n < 8 ? 'badge-red' : n < 12 ? 'badge-yellow' : 'badge-green');
    return `<span class="badge ${cls}">${esc(v)}</span>`;
  }

  function inrBadge(v) {
    if (!v) return esc('');
    const n = parseFloat(v);
    const cls = isNaN(n) ? 'badge-blue' : (n > 1.5 ? 'badge-red' : 'badge-green');
    return `<span class="badge ${cls}">${esc(v)}</span>`;
  }

  function labBadge(v) {
    if (!v) return esc('');
    const low = v.toLowerCase();
    const cls = low.includes('ØºÙŠØ±') || low.includes('abnormal') ? 'badge-red' : 'badge-green';
    return `<span class="badge ${cls}">${esc(v)}</span>`;
  }

  function virBadge(v) {
    if (!v) return esc('');
    const low = v.toLowerCase();
    const cls = low.includes('Ø¥ÙŠØ¬Ø§Ø¨ÙŠ') || low.includes('positive') ? 'badge-red' : 'badge-green';
    return `<span class="badge ${cls}">${esc(v)}</span>`;
  }

  function updateStats() {
    document.getElementById('statTotal').textContent = patients.length;
    document.getElementById('statAdmitted').textContent = patients.filter(p=>p.decision==='Ù‚Ø¨ÙˆÙ„').length;
    document.getElementById('statPending').textContent = patients.filter(p=>p.decision==='Ø§Ù†ØªØ¸Ø§Ø±').length;
  }

  function sortBy(key) {
    if (sortKey === key) sortAsc = !sortAsc;
    else { sortKey = key; sortAsc = true; }
    renderTable();
  }

  // â”€â”€â”€ CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function openAddModal() {
    editingId = null;
    document.getElementById('modalTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯';
    clearForm();
    document.getElementById('patientModal').classList.add('active');
  }

  function openEditModal(id) {
    const p = patients.find(x => x.id === id);
    if (!p) return;
    editingId = id;
    document.getElementById('modalTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶';
    fillForm(p);
    document.getElementById('patientModal').classList.add('active');
  }

  function closeModal() { document.getElementById('patientModal').classList.remove('active'); }
  function closeConfigModal() { document.getElementById('configModal').classList.remove('active'); }
  function openConfigModal() { document.getElementById('configModal').classList.add('active'); }

  function clearForm() {
    ['name','age','diagnosis','decision','hb','plt','inr','lft','rft','abo','vir','anastasia','skin','notes']
      .forEach(f => { const el = document.getElementById('f_'+f); if(el) el.value = ''; });
  }

  function fillForm(p) {
    ['name','age','diagnosis','decision','hb','plt','inr','lft','rft','abo','vir','anastasia','skin','notes']
      .forEach(f => { const el = document.getElementById('f_'+f); if(el) el.value = p[f] || ''; });
  }

  function formData() {
    return ['name','age','diagnosis','decision','hb','plt','inr','lft','rft','abo','vir','anastasia','skin','notes']
      .reduce((obj, f) => { obj[f] = document.getElementById('f_'+f)?.value?.trim() || ''; return obj; }, {});
  }

  function savePatient() {
    const data = formData();
    if (!data.name) { showToast('âŒ Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨', 'error'); return; }

    if (editingId) {
      const idx = patients.findIndex(p => p.id === editingId);
      patients[idx] = { ...patients[idx], ...data };
      syncToSheets('update', patients[idx]);
      showToast('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶', 'success');
    } else {
      const newPatient = { id: nextId++, ...data };
      patients.push(newPatient);
      localStorage.setItem('nextId', nextId);
      syncToSheets('add', newPatient);
      showToast('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }

    saveLocal();
    renderTable();
    closeModal();
  }

  function deletePatient(id) {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙŠØ¶ØŸ')) return;
    const p = patients.find(x => x.id === id);
    const rowIndex = patients.indexOf(p);
    patients = patients.filter(x => x.id !== id);
    syncToSheets('delete', { id: rowIndex + 1 });
    saveLocal();
    renderTable();
    showToast('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶', 'info');
  }

  function saveLocal() {
    localStorage.setItem('patients', JSON.stringify(patients));
  }

  // â”€â”€â”€ Sheets Sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function syncToSheets(action, rowData) {
    if (!sheetsUrl) return;
    setSyncing(true);
    try {
      const body = { action, row: sheetsRow(rowData), id: rowData.id };
      await fetch(sheetsUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
        mode: 'no-cors'
      });
      setSyncing(false);
      updateLastSync();
    } catch(e) {
      setSyncing(false);
      showToast('âš ï¸ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Google Sheets', 'error');
    }
  }

  function sheetsRow(p) {
    return {
      Name: p.name, Age: p.age, Diagnosis: p.diagnosis, Decision: p.decision,
      Hb: p.hb, Plt: p.plt, INR: p.inr, LFT: p.lft, RFT: p.rft,
      ABO: p.abo, VIR: p.vir, Anastasia: p.anastasia, Skin: p.skin, Notes: p.notes
    };
  }

  async function syncFromSheets() {
    if (!sheetsUrl) { showToast('âš ï¸ Ø£Ø¶Ù Ø±Ø§Ø¨Ø· Google Sheets Ø£ÙˆÙ„Ø§Ù‹', 'error'); return; }
    setSyncing(true);
    showToast('ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...', 'info');
    try {
      const res = await fetch(sheetsUrl + '?t=' + Date.now());
      const json = await res.json();
      if (json.data) {
        patients = json.data.map((row, i) => ({
          id: i+1,
          name: row.Name || '',
          age: row.Age || '',
          diagnosis: row.Diagnosis || '',
          decision: row.Decision || '',
          hb: row.Hb || '',
          plt: row.Plt || '',
          inr: row.INR || '',
          lft: row.LFT || '',
          rft: row.RFT || '',
          abo: row.ABO || '',
          vir: row.VIR || '',
          anastasia: row.Anastasia || '',
          skin: row.Skin || '',
          notes: row.Notes || ''
        }));
        nextId = patients.length + 1;
        localStorage.setItem('nextId', nextId);
        saveLocal();
        renderTable();
        updateLastSync();
        showToast('âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
      }
    } catch(e) {
      showToast('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ â€“ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·', 'error');
    }
    setSyncing(false);
  }

  function updateSyncStatus(connected) {
    const dot = document.getElementById('syncDot');
    const text = document.getElementById('syncText');
    if (connected) {
      dot.classList.remove('syncing');
      text.textContent = 'Ù…ØªØµÙ„ Ø¨Ù€ Google Sheets';
    } else {
      text.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ù€ Google Sheets';
    }
  }

  function setSyncing(v) {
    document.getElementById('syncDot').classList.toggle('syncing', v);
  }

  function updateLastSync() {
    const now = new Date();
    document.getElementById('statSync').textContent =
      now.toLocaleTimeString('ar-SA', {hour:'2-digit', minute:'2-digit'});
  }

  function saveConfig() {
    sheetsUrl = document.getElementById('sheetsUrl').value.trim();
    localStorage.setItem('sheetsUrl', sheetsUrl);
    updateSyncStatus(!!sheetsUrl);
    closeConfigModal();
    showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', 'success');
  }

  async function testConnection() {
    const url = document.getElementById('sheetsUrl').value.trim();
    if (!url) { showToast('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ø§Ø¨Ø· Ø£ÙˆÙ„Ø§Ù‹', 'error'); return; }
    showToast('ğŸ”Œ Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...', 'info');
    try {
      const res = await fetch(url + '?test=1&t=' + Date.now());
      const json = await res.json();
      showToast('âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­!', 'success');
    } catch(e) {
      showToast('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§ØªØµØ§Ù„ â€“ ØªØ­Ù‚Ù‚ Ù…Ù† URL ÙˆØ§Ù„Ø£Ø°ÙˆÙ†Ø§Øª', 'error');
    }
  }

  // â”€â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function showToast(msg, type='info') {
    const t = document.createElement('div');
    t.className = `toast ${type}`;
    t.textContent = msg;
    document.getElementById('toastContainer').appendChild(t);
    setTimeout(() => t.remove(), 3500);
  }

  // â”€â”€â”€ Close on outside click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.querySelectorAll('.modal-overlay').forEach(overlay => {
    overlay.addEventListener('click', e => { if(e.target === overlay) { overlay.classList.remove('active'); } });
  });

  // â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  renderTable();
</script>
</body>
</html>
